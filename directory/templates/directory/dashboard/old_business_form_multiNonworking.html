{% extends "directory/dashboard/base.html" %}
{% load static %}
{% load directory_filters %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="mb-4">{% if is_edit %}Edit{% else %}Add New{% endif %} Business</h1>


            {% if is_edit and business.pk %}
                <form method="post" action="{% url 'directory:edit_business' business.pk %}" enctype="multipart/form-data" class="needs-validation" id="businessForm">
            {% else %}
                <form method="post" action="{% url 'directory:add_business' %}" enctype="multipart/form-data" class="needs-validation" id="businessForm">
            {% endif %}  
            
            {% csrf_token %}
            
            <!-- Hidden location fields -->
            <input type="hidden" name="latitude" id="latitude" value="{{ business.latitude|default:'' }}">
            <input type="hidden" name="longitude" id="longitude" value="{{ business.longitude|default:'' }}">
            <input type="hidden" name="place_id" id="place_id" value="{{ business.place_id|default:'' }}">
            <input type="hidden" name="location_name" id="location_name" value="{{ business.location_name|default:'' }}">
            <input type="hidden" name="formatted_address" id="formatted_address" value="{{ business.formatted_address|default:'' }}">

            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Basic Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-info-circle me-2"></i>Basic Information
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Business Name <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                Category <span class="text-danger">*</span>
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">{{ form.category.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                Business Description <span class="text-danger">*</span>
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-telephone me-2"></i>Contact Information
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.phone.id_for_label }}" class="form-label">
                                Phone Number <span class="text-danger">*</span>
                            </label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                Email Address <span class="text-danger">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.website.id_for_label }}" class="form-label">
                                Website (Optional)
                            </label>
                            {{ form.website }}
                            {% if form.website.errors %}
                                <div class="invalid-feedback d-block">{{ form.website.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Documents -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-shield-check me-2"></i>Business Verification
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.registration_number.id_for_label }}" class="form-label">
                                Registration Number (Optional)
                            </label>
                            {{ form.registration_number }}
                            {% if form.registration_number.errors %}
                                <div class="invalid-feedback d-block">{{ form.registration_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.gst_number.id_for_label }}" class="form-label">
                                GST Number (Optional)
                            </label>
                            {{ form.gst_number }}
                            {% if form.gst_number.errors %}
                                <div class="invalid-feedback d-block">{{ form.gst_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-geo-alt me-2"></i>Business Location
                    </h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label for="location_search" class="form-label">
                                Search Your Business Location <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="location_search" placeholder="Type your business address...">
                        </div>
                    </div>
                    
                    <!-- Map -->
                    <div id="map" style="height: 400px; border-radius: 8px;" class="mb-4"></div>
                    
                    <!-- Location Display Fields -->
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Full Address</label>
                            <textarea class="form-control bg-light" id="address_display" rows="3" readonly>{{ business.formatted_address|default:business.address|default:'' }}</textarea>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">City/District</label>
                            <input type="text" class="form-control bg-light" name="district" id="district_display" value="{{ business.district|default:'' }}" readonly>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control bg-light" id="state_display" value="{{ business.state|default:'' }}" readonly>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Pincode</label>
                            <input type="text" class="form-control bg-light" id="pincode_display" value="{{ business.pincode|default:'' }}" readonly>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Latitude</label>
                            <input type="text" class="form-control bg-light" id="lat_display" value="{{ business.latitude|default:'' }}" readonly>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Longitude</label>
                            <input type="text" class="form-control bg-light" id="lng_display" value="{{ business.longitude|default:'' }}" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2 mb-5">
                <button type="submit" name="action" value="draft" class="btn btn-outline-primary">
                    <i class="bi bi-save me-1"></i>Save as Draft
                </button>
                <button type="submit" name="action" value="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Submit for Approval
                </button>
                <a href="{% url 'directory:dashboard_listings' %}" class="btn btn-outline-secondary ms-auto">Cancel</a>
            </div>
</form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Google Maps Variables
let map;
let marker;
let autocomplete;
let geocoder;

// Initialize Google Maps
function initMap() {
    console.log('Initializing Google Maps...');
    
    const defaultLocation = { lat: 12.9716, lng: 77.5946 }; // Bangalore
    
    // Initialize map
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: defaultLocation,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    });
    
    // Initialize marker
    marker = new google.maps.Marker({
        position: defaultLocation,
        map: map,
        draggable: true,
        title: 'Business Location'
    });
    
    // Initialize geocoder
    geocoder = new google.maps.Geocoder();
    
    // Setup autocomplete
    const searchInput = document.getElementById('location_search');
    autocomplete = new google.maps.places.Autocomplete(searchInput, {
        componentRestrictions: { country: 'IN' },
        fields: ['place_id', 'geometry', 'name', 'formatted_address', 'address_components']
    });
    
    // Handle place selection
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (place.geometry) {
            updateLocationFromPlace(place);
        }
    });
    
    // Handle marker drag
    marker.addListener('dragend', function() {
        const position = marker.getPosition();
        reverseGeocode(position.lat(), position.lng());
    });
    
    // Load existing location if editing
    const existingLat = document.getElementById('latitude').value;
    const existingLng = document.getElementById('longitude').value;
    
    if (existingLat && existingLng) {
        const existingLocation = {
            lat: parseFloat(existingLat),
            lng: parseFloat(existingLng)
        };
        map.setCenter(existingLocation);
        marker.setPosition(existingLocation);
    }
    
    console.log('✅ Google Maps initialized');
}

// Update location from selected place
function updateLocationFromPlace(place) {
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    
    const position = { lat: lat, lng: lng };
    map.setCenter(position);
    marker.setPosition(position);
    map.setZoom(15);
    
    const addressData = extractAddressData(place);
    addressData.latitude = lat;
    addressData.longitude = lng;
    
    updateLocationFields(addressData);
}

// Extract address data from Google place
function extractAddressData(place) {
    const data = {
        place_id: place.place_id || '',
        formatted_address: place.formatted_address || '',
        location_name: place.name || '',
        address: '',
        city: '',
        district: '',
        state: '',
        pincode: ''
    };
    
    // Parse district from formatted address
    if (place.formatted_address) {
        const addressParts = place.formatted_address.split(',').map(part => part.trim());
        
        // Find the part with State and Pincode
        let statePincodeIndex = -1;
        for (let i = addressParts.length - 1; i >= 0; i--) {
            if (/[A-Za-z]+\s+\d{6}/.test(addressParts[i]) || /\d{6}/.test(addressParts[i])) {
                statePincodeIndex = i;
                break;
            }
        }
        
        // The part BEFORE State-Pincode is the District/City
        if (statePincodeIndex > 0) {
            data.district = addressParts[statePincodeIndex - 1];
        }
    }
    
    // Extract components
    if (place.address_components) {
        place.address_components.forEach(component => {
            const types = component.types;
            
            if (types.includes('locality') && !data.city) {
                data.city = component.long_name;
            }
            
            if (types.includes('administrative_area_level_1')) {
                data.state = component.long_name;
            }
            
            if (types.includes('postal_code')) {
                data.pincode = component.long_name;
            }
        });
    }
    
    // Use city as district fallback
    if (!data.district && data.city) {
        data.district = data.city;
    }
    
    data.address = data.formatted_address;
    return data;
}

// Update location fields
function updateLocationFields(data) {
    // Update hidden fields
    document.getElementById('latitude').value = data.latitude || '';
    document.getElementById('longitude').value = data.longitude || '';
    document.getElementById('place_id').value = data.place_id || '';
    document.getElementById('location_name').value = data.location_name || '';
    document.getElementById('formatted_address').value = data.formatted_address || '';
    
    // Update display fields
    document.getElementById('address_display').value = data.address || data.formatted_address || '';
    document.getElementById('district_display').value = data.district || '';
    document.getElementById('state_display').value = data.state || '';
    document.getElementById('pincode_display').value = data.pincode || '';
    document.getElementById('lat_display').value = data.latitude ? data.latitude.toFixed(6) : '';
    document.getElementById('lng_display').value = data.longitude ? data.longitude.toFixed(6) : '';
    
    console.log('✅ Location fields updated');
}

// Reverse geocode
function reverseGeocode(lat, lng) {
    geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const addressData = extractAddressData(results[0]);
            addressData.latitude = lat;
            addressData.longitude = lng;
            updateLocationFields(addressData);
        }
    });
}

// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('businessForm');
    
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submitting...');
            
            const submitButton = e.submitter || document.activeElement;
            const action = submitButton ? submitButton.value : 'draft';
            
            // Only validate location for final submission
            if (action === 'submit') {
                const lat = document.getElementById('latitude').value;
                const lng = document.getElementById('longitude').value;
                
                if (!lat || !lng) {
                    e.preventDefault();
                    alert('Please select your business location on the map.');
                    document.getElementById('location_search').focus();
                    return false;
                }
            }
            
            // Show loading state
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            }
            
            return true;
        });
    }
    
    // Load Google Maps
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
});
</script>
{% endblock %}