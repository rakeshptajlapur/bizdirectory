{% extends "directory/dashboard/base.html" %}
{% load static %}
{% load directory_filters %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">{% if is_edit %}Edit{% else %}Add New{% endif %} Business</h1>

    <form method="post" enctype="multipart/form-data" class="needs-validation" id="businessForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <!-- Basic Information Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-info-circle me-2"></i>Basic Information
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            Business Name <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Business name should be 3-100 characters. Can include letters, numbers, spaces, and common symbols like &, -, etc."></i>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Enter your official business name (3-100 characters)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            Category <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Select the category that best describes your business"></i>
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.category.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Business Description <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Describe your business in 50-1000 characters. Include services, specialties, and what makes you unique"></i>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Describe your business, services offered, unique selling points, etc. (50-1000 characters)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-geo-alt me-2"></i>Location & Contact Details
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="{{ form.address.id_for_label }}" class="form-label">
                            Address <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter your complete business address with landmarks if any (10-200 characters)"></i>
                        </label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.address.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Complete business address with landmarks (10-200 characters)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.city.id_for_label }}" class="form-label">
                            City <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="City name should contain only letters and spaces. No numbers allowed"></i>
                        </label>
                        {{ form.city }}
                        {% if form.city.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.city.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">City name (letters and spaces only)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.pincode.id_for_label }}" class="form-label">
                            Pincode <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter valid 6-digit Indian postal code (e.g., 110001)"></i>
                        </label>
                        {{ form.pincode }}
                        {% if form.pincode.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.pincode.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">6-digit postal code (e.g., 110001)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.phone.id_for_label }}" class="form-label">
                            Phone Number <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter 10-digit mobile number without country code (e.g., 9876543210)"></i>
                        </label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.phone.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">10-digit mobile number (e.g., 9876543210)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            Email Address <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Valid business email address (e.g., info@business.com)"></i>
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.email.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Business email for customer inquiries</div>
                    </div>
                    
                    <div class="col-md-12">
                        <label for="{{ form.website.id_for_label }}" class="form-label">
                            Website (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter complete website URL starting with http:// or https:// (e.g., https://mybusiness.com)"></i>
                        </label>
                        {{ form.website }}
                        {% if form.website.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.website.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Complete URL including http:// or https:// (e.g., https://example.com)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KYC & Registration Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-shield-check me-2"></i>Business Verification Details
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.registration_number.id_for_label }}" class="form-label">
                            Registration Number <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Business registration number: 4-20 characters, can be alphanumeric (e.g., U12345MH2020PTC123456)"></i>
                        </label>
                        {{ form.registration_number }}
                        {% if form.registration_number.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.registration_number.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Business registration/CIN number (4-20 characters)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.gst_number.id_for_label }}" class="form-label">
                            GST Number (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="15-character GST number (e.g., 27AAPFU0939F1ZV). Format: 2 digits + 10 chars + 1 char + 1 char + Z + 1 char"></i>
                        </label>
                        {{ form.gst_number }}
                        {% if form.gst_number.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.gst_number.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">15-character GST number (e.g., 27AAPFU0939F1ZV)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">
                            Registration Certificate (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Upload clear image of business registration certificate. Accepted: JPG, PNG • Max: 5MB"></i>
                        </label>
                        <input type="file" class="form-control" name="registration_document" accept="image/jpeg,image/jpg,image/png">
                        <div class="form-text">
                            <strong>Image formats:</strong> JPG, PNG only • <strong>Max size:</strong> 5MB<br>
                            Upload clear image of your business registration certificate
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">
                            GST Certificate (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Upload clear image of GST registration certificate. Accepted: JPG, PNG • Max: 5MB"></i>
                        </label>
                        <input type="file" class="form-control" name="gst_document" accept="image/jpeg,image/jpg,image/png">
                        <div class="form-text">
                            <strong>Image formats:</strong> JPG, PNG only • <strong>Max size:</strong> 5MB<br>
                            Upload clear image of your GST certificate
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Upload Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-images me-2"></i>Business Images
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            Primary Business Image {% if not business %}<span class="text-danger">*</span>{% endif %}
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="High-quality image representing your business. Accepted: JPG, PNG • Max: 5MB • Recommended: 1200x800px"></i>
                        </label>
                        <input type="file" class="form-control" name="primary_image" accept="image/jpeg,image/jpg,image/png" {% if not business %}required{% endif %}>
                        <div class="form-text">
                            <strong>Image formats:</strong> JPG, PNG only • <strong>Max size:</strong> 5MB<br>
                            <strong>Recommended:</strong> High-quality, well-lit photo of your business exterior/interior
                        </div>
                        
                        {% if business and business.get_primary_image %}
                            <div class="mt-2">
                                <img src="{{ business.get_primary_image.image.url }}" alt="Primary Image" class="img-thumbnail" style="height: 100px;">
                                <p class="mt-1 mb-0 small text-muted">Current primary image</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Hours Card -->
        {% with subscription=request.user|get_subscription %}
            {% if subscription.plan.price > 0 %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-clock me-2"></i>Business Hours
                        </h5>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Status</th>
                                        <th>Opening Time</th>
                                        <th>Closing Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for day in days_of_week %}
                                        {% with day_hours=business_hours|get_item:day.number %}
                                        <tr>
                                            <td>
                                                <label class="form-label mb-0">{{ day.name }}</label>
                                            </td>
                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input business-day-toggle" type="checkbox" 
                                                           id="closed_{{ day.number }}" name="closed_{{ day.number }}"
                                                           data-target="time-row-{{ day.number }}"
                                                           {% if day_hours.is_closed %}checked{% endif %}>
                                                    <label class="form-check-label" for="closed_{{ day.number }}">
                                                        Closed
                                                    </label>
                                                </div>
                                            </td>
                                            <td>
                                                <div id="time-row-{{ day.number }}" class="{% if day_hours.is_closed %}d-none{% endif %}">
                                                    <input type="time" class="form-control" name="open_time_{{ day.number }}" 
                                                           value="{{ day_hours.open_time|default:'09:00' }}"
                                                           {% if day_hours.is_closed %}disabled{% endif %}>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="{% if day_hours.is_closed %}d-none{% endif %}" id="close-time-{{ day.number }}">
                                                    <input type="time" class="form-control" name="close_time_{{ day.number }}" 
                                                           value="{{ day_hours.close_time|default:'17:00' }}"
                                                           {% if day_hours.is_closed %}disabled{% endif %}>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Services Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-tag me-2"></i>Services Offered
                </h5>
                
                <div id="services-container">
                    {% if services %}
                        {% for service in services %}
                        <div class="row g-3 mb-3 service-row">
                            <div class="col-md-5">
                                <label class="form-label">
                                    Service Name
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Service name: 2-100 characters, letters and numbers allowed (e.g., Web Development, AC Repair)"></i>
                                </label>
                                <input type="text" class="form-control service-name" name="service_name" value="{{ service.name }}" maxlength="100">
                                <div class="form-text">2-100 characters, letters and numbers</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    Short Description (Optional)
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Brief description of the service: up to 200 characters"></i>
                                </label>
                                <input type="text" class="form-control service-description" name="service_description" value="{{ service.description }}" maxlength="200">
                                <div class="form-text">Up to 200 characters</div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger remove-service-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="row g-3 mb-3 service-row">
                            <div class="col-md-5">
                                <label class="form-label">
                                    Service Name
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Service name: 2-100 characters, letters and numbers allowed (e.g., Web Development, AC Repair)"></i>
                                </label>
                                <input type="text" class="form-control service-name" name="service_name" maxlength="100">
                                <div class="form-text">2-100 characters, letters and numbers</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    Short Description (Optional)
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Brief description of the service: up to 200 characters"></i>
                                </label>
                                <input type="text" class="form-control service-description" name="service_description" maxlength="200">
                                <div class="form-text">Up to 200 characters</div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger remove-service-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="mt-3">
                    <button type="button" id="add-service-btn" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-1"></i>Add Another Service
                    </button>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex gap-2 mb-5">
            <button type="submit" name="action" value="draft" class="btn btn-outline-primary">Save as Draft</button>
            <button type="submit" name="action" value="submit" class="btn btn-primary">Submit for Approval</button>
            <a href="{% url 'directory:dashboard_listings' %}" class="btn btn-outline-secondary ms-auto">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Business name validation
    const nameInput = document.querySelector('input[name="name"]');
    nameInput.addEventListener('input', function() {
        const nameRegex = /^[a-zA-Z0-9\s\-&.,()]+$/;
        if (this.value.length < 3) {
            setValidationError(this, 'Business name must be at least 3 characters');
        } else if (this.value.length > 100) {
            setValidationError(this, 'Business name cannot exceed 100 characters');
        } else if (!nameRegex.test(this.value)) {
            setValidationError(this, 'Business name can only contain letters, numbers, spaces, and common symbols');
        } else if (/^\d+$/.test(this.value)) {
            setValidationError(this, 'Business name cannot be numbers only');
        } else {
            clearValidationError(this);
        }
    });
    
    // Description validation
    const descriptionInput = document.querySelector('textarea[name="description"]');
    descriptionInput.addEventListener('input', function() {
        if (this.value.length < 50) {
            setValidationError(this, 'Description should be at least 50 characters');
        } else if (this.value.length > 1000) {
            setValidationError(this, 'Description cannot exceed 1000 characters');
        } else {
            clearValidationError(this);
        }
    });
    
    // Address validation
    const addressInput = document.querySelector('textarea[name="address"]');
    addressInput.addEventListener('input', function() {
        if (this.value.length < 10) {
            setValidationError(this, 'Address should be at least 10 characters');
        } else if (this.value.length > 200) {
            setValidationError(this, 'Address cannot exceed 200 characters');
        } else {
            clearValidationError(this);
        }
    });
    
    // City validation (letters and spaces only)
    const cityInput = document.querySelector('input[name="city"]');
    cityInput.addEventListener('input', function() {
        const cityRegex = /^[a-zA-Z\s]+$/;
        if (this.value.length < 2) {
            setValidationError(this, 'City name must be at least 2 characters');
        } else if (!cityRegex.test(this.value)) {
            setValidationError(this, 'City name can only contain letters and spaces');
        } else {
            clearValidationError(this);
        }
    });
    
    // Pincode validation
    const pincodeInput = document.querySelector('input[name="pincode"]');
    pincodeInput.addEventListener('input', function() {
        const pincodeRegex = /^[0-9]{6}$/;
        if (!pincodeRegex.test(this.value)) {
            setValidationError(this, 'Please enter a valid 6-digit pincode');
        } else {
            clearValidationError(this);
        }
    });
    
    // Phone number validation
    const phoneInput = document.querySelector('input[name="phone"]');
    phoneInput.addEventListener('input', function() {
        const phoneRegex = /^[6-9][0-9]{9}$/;
        if (!phoneRegex.test(this.value)) {
            setValidationError(this, 'Please enter a valid 10-digit mobile number starting with 6-9');
        } else {
            clearValidationError(this);
        }
    });
    
    // Email validation
    const emailInput = document.querySelector('input[name="email"]');
    emailInput.addEventListener('input', function() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(this.value)) {
            setValidationError(this, 'Please enter a valid email address');
        } else {
            clearValidationError(this);
        }
    });
    
    // Website validation (optional field)
    const websiteInput = document.querySelector('input[name="website"]');
    websiteInput.addEventListener('input', function() {
        if (this.value) {
            const urlRegex = /^(https?:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/;
            if (!urlRegex.test(this.value)) {
                setValidationError(this, 'Please enter a valid website URL (e.g., https://example.com)');
            } else {
                clearValidationError(this);
            }
        } else {
            clearValidationError(this);
        }
    });
    
    // Registration number validation
    const regNumInput = document.querySelector('input[name="registration_number"]');
    regNumInput.addEventListener('input', function() {
        const regRegex = /^[A-Z0-9]+$/;
        if (this.value.length < 4 || this.value.length > 20) {
            setValidationError(this, 'Registration number must be 4-20 characters');
        } else if (!regRegex.test(this.value.toUpperCase())) {
            setValidationError(this, 'Registration number can only contain letters and numbers');
        } else {
            clearValidationError(this);
        }
    });
    
    // GST number validation
    const gstInput = document.querySelector('input[name="gst_number"]');
    if (gstInput) {
        gstInput.addEventListener('input', function() {
            if (this.value) {
                const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
                if (!gstRegex.test(this.value.toUpperCase())) {
                    setValidationError(this, 'Please enter a valid GST number (e.g., 27AAPFU0939F1ZV)');
                } else {
                    clearValidationError(this);
                }
            } else {
                clearValidationError(this);
            }
        });
    }
    
    // File validation function
    function validateImageFile(input, fieldName) {
        const file = input.files[0];
        if (!file) return true;
        
        // Size check (5MB)
        if (file.size > 5 * 1024 * 1024) {
            setValidationError(input, `${fieldName} size must be less than 5MB`);
            input.value = '';
            return false;
        }
        
        // Type check
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
            setValidationError(input, `${fieldName} must be JPG or PNG image`);
            input.value = '';
            return false;
        }
        
        clearValidationError(input);
        return true;
    }
    
    // File input validations
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            let fieldName = 'File';
            if (this.name === 'primary_image') fieldName = 'Business image';
            else if (this.name === 'registration_document') fieldName = 'Registration certificate';
            else if (this.name === 'gst_document') fieldName = 'GST certificate';
            
            validateImageFile(this, fieldName);
        });
    });
    
    // Service validation
    function validateService(serviceRow) {
        const nameInput = serviceRow.querySelector('.service-name');
        const descInput = serviceRow.querySelector('.service-description');
        
        if (nameInput.value.trim()) {
            const serviceRegex = /^[a-zA-Z0-9\s\-&.,()]+$/;
            if (nameInput.value.length < 2) {
                setValidationError(nameInput, 'Service name must be at least 2 characters');
            } else if (!serviceRegex.test(nameInput.value)) {
                setValidationError(nameInput, 'Service name can only contain letters, numbers, spaces, and common symbols');
            } else {
                clearValidationError(nameInput);
            }
        }
        
        if (descInput.value.trim() && descInput.value.length > 200) {
            setValidationError(descInput, 'Description cannot exceed 200 characters');
        } else {
            clearValidationError(descInput);
        }
    }
    
    // Validation helper functions
    function setValidationError(input, message) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        
        let feedback = input.parentElement.querySelector('.invalid-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            input.parentElement.appendChild(feedback);
        }
        feedback.textContent = message;
    }
    
    function clearValidationError(input) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        
        const feedback = input.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
            feedback.remove();
        }
    }
    
    // Business hours toggle
    document.querySelectorAll('.business-day-toggle').forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            const targetId = this.dataset.target;
            const timeInputs = document.querySelectorAll('#' + targetId + ' input, #close-time-' + targetId.split('-')[2] + ' input');
            const timeRows = document.querySelectorAll('#' + targetId + ', #close-time-' + targetId.split('-')[2]);
            
            if (this.checked) {
                timeRows.forEach(row => row.classList.add('d-none'));
                timeInputs.forEach(input => input.disabled = true);
            } else {
                timeRows.forEach(row => row.classList.remove('d-none'));
                timeInputs.forEach(input => input.disabled = false);
            }
        });
    });
    
    // Add service
    document.getElementById('add-service-btn').addEventListener('click', function() {
        const servicesContainer = document.getElementById('services-container');
        const serviceRow = document.querySelector('.service-row').cloneNode(true);
        
        // Clear inputs and reset validation
        serviceRow.querySelectorAll('input').forEach(input => {
            input.value = '';
            input.classList.remove('is-valid', 'is-invalid');
        });
        serviceRow.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
        
        // Add validation to new inputs
        const nameInput = serviceRow.querySelector('.service-name');
        const descInput = serviceRow.querySelector('.service-description');
        
        nameInput.addEventListener('input', () => validateService(serviceRow));
        descInput.addEventListener('input', () => validateService(serviceRow));
        
        // Add remove event listener
        serviceRow.querySelector('.remove-service-btn').addEventListener('click', function() {
            if (document.querySelectorAll('.service-row').length > 1) {
                this.closest('.service-row').remove();
            }
        });
        
        servicesContainer.appendChild(serviceRow);
    });
    
    // Initial setup for remove service buttons and validation
    document.querySelectorAll('.service-row').forEach(function(row) {
        const nameInput = row.querySelector('.service-name');
        const descInput = row.querySelector('.service-description');
        
        nameInput.addEventListener('input', () => validateService(row));
        descInput.addEventListener('input', () => validateService(row));
        
        row.querySelector('.remove-service-btn').addEventListener('click', function() {
            if (document.querySelectorAll('.service-row').length > 1) {
                this.closest('.service-row').remove();
            }
        });
    });
});
</script>
{% endblock %}

{% with subscription=business.subscription %}
    <!-- Basic business info section (always visible) -->
    <!-- ... -->

    <!-- Premium features - only show if paid plan -->
    {% if business.has_premium_features %}
        <!-- Business Hours Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">Business Hours</h5>
                <!-- Hours content -->
            </div>
        </div>
        
        <!-- Additional images gallery -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">Image Gallery</h5>
                <!-- Gallery content -->
            </div>
        </div>
    {% else %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center">
                <h5 class="border-bottom pb-2 mb-3">Premium Features</h5>
                <p class="text-muted">
                    <i class="bi bi-lock"></i> Unlock advanced features with our Premium plan:
                </p>
                <ul class="list-unstyled mb-4">
                    <li><i class="bi bi-check-circle me-2"></i> Business hours management</li>
                    <li><i class="bi bi-check-circle me-2"></i> Multiple image gallery</li>
                    <li><i class="bi bi-check-circle me-2"></i> Verification badges</li>
                    <li><i class="bi bi-check-circle me-2"></i> Advanced analytics</li>
                </ul>
                <a href="{% url 'directory:subscription_plans' %}?for_business={{ business.id }}" class="btn btn-primary">
                    Upgrade to Premium
                </a>
            </div>
        </div>
    {% endif %}
{% endwith %}