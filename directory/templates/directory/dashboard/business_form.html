{% extends "directory/dashboard/base.html" %}
{% load static %}
{% load directory_filters %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">{% if is_edit %}Edit{% else %}Add New{% endif %} Business</h1>

{% if is_edit and business.pk %}
    <form method="post" action="{% url 'directory:edit_business' business.pk %}" enctype="multipart/form-data" class="needs-validation" id="businessForm">
{% else %}
    <form method="post" action="{% url 'directory:add_business' %}" enctype="multipart/form-data" class="needs-validation" id="businessForm">
{% endif %}        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <!-- Basic Information Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-info-circle me-2"></i>Basic Information
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            Business Name <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Business name should be 3-100 characters. Can include letters, numbers, spaces, and common symbols like &, -, etc."></i>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Enter your official business name (3-100 characters)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            Category <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Select the category that best describes your business"></i>
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.category.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-12">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Business Description <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Describe your business in 50-1000 characters. Include services, specialties, and what makes you unique"></i>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Describe your business, services offered, unique selling points, etc. (50-1000 characters)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KYC & Registration Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-shield-check me-2"></i>Business Verification Details
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.registration_number.id_for_label }}" class="form-label">
                            Registration Number <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Business registration number: 4-20 characters, can be alphanumeric (e.g., U12345MH2020PTC123456)"></i>
                        </label>
                        {{ form.registration_number }}
                        {% if form.registration_number.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.registration_number.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Business registration/CIN number (4-20 characters)</div>
                        
                        <!-- Conditional Registration Document Upload -->
                        <div id="registration-upload-section" class="mt-3" style="display: {% if business.registration_number %}block{% else %}none{% endif %};">
                            <label class="form-label">
                                Registration Certificate <span class="text-danger">*</span>
                                <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                   title="Upload clear image/PDF of business registration certificate. Accepted: JPG, PNG, PDF • Max: 5MB"></i>
                            </label>
                            <input type="file" class="form-control" name="registration_document" accept="image/jpeg,image/jpg,image/png,application/pdf">
                            <div class="form-text">
                                <strong>Accepted formats:</strong> JPG, PNG, PDF • <strong>Max size:</strong> 5MB<br>
                                Upload clear image or PDF of your business registration certificate
                            </div>
                            
                            {% if business and business.registration_document %}
                                <div class="mt-2">
                                    <div class="d-flex align-items-center">
                                        <a href="{{ business.registration_document.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                            <i class="bi bi-eye me-1"></i> View Certificate
                                        </a>
                                        <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Uploaded</span>
                                    </div>
                                    <p class="mt-1 mb-0 small text-muted">You can upload a new file to replace it</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.gst_number.id_for_label }}" class="form-label">
                            GST Number (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="15-character GST number (e.g., 27AAPFU0939F1ZV). Format: 2 digits + 10 chars + 1 char + 1 char + Z + 1 char"></i>
                        </label>
                        {{ form.gst_number }}
                        {% if form.gst_number.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.gst_number.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">15-character GST number (e.g., 27AAPFU0939F1ZV)</div>
                        
                        <!-- Conditional GST Document Upload -->
                        <div id="gst-upload-section" class="mt-3" style="display: {% if business.gst_number %}block{% else %}none{% endif %};">
                            <label class="form-label">
                                GST Certificate <span class="text-danger">*</span>
                                <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                   title="Upload clear image/PDF of GST registration certificate. Accepted: JPG, PNG, PDF • Max: 5MB"></i>
                            </label>
                            <input type="file" class="form-control" name="gst_document" accept="image/jpeg,image/jpg,image/png,application/pdf">
                            <div class="form-text">
                                <strong>Accepted formats:</strong> JPG, PNG, PDF • <strong>Max size:</strong> 5MB<br>
                                Upload clear image or PDF of your GST certificate
                            </div>
                            
                            {% if business and business.gst_document %}
                                <div class="mt-2">
                                    <div class="d-flex align-items-center">
                                        <a href="{{ business.gst_document.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                            <i class="bi bi-eye me-1"></i> View Certificate
                                        </a>
                                        <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Uploaded</span>
                                    </div>
                                    <p class="mt-1 mb-0 small text-muted">You can upload a new file to replace it</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Help Text -->
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Verification Benefits:</strong> Upload documents to get verification badges, improve search rankings, and build customer trust.
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-telephone me-2"></i>Contact Information
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.phone.id_for_label }}" class="form-label">
                            Phone Number <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter 10-digit mobile number without country code (e.g., 9876543210)"></i>
                        </label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.phone.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">10-digit mobile number (e.g., 9876543210)</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            Email Address <span class="text-danger">*</span>
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Valid business email address (e.g., info@business.com)"></i>
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.email.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Business email for customer inquiries</div>
                    </div>
                    
                    <div class="col-md-12">
                        <label for="{{ form.website.id_for_label }}" class="form-label">
                            Website (Optional)
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter complete website URL starting with http:// or https:// (e.g., https://mybusiness.com)"></i>
                        </label>
                        {{ form.website }}
                        {% if form.website.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.website.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Complete URL including http:// or https:// (e.g., https://example.com)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Upload Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-images me-2"></i>Business Images
                </h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            Primary Business Image {% if not business %}<span class="text-danger">*</span>{% endif %}
                            <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="High-quality image representing your business. Accepted: JPG, PNG • Max: 5MB • Recommended: 1200x800px"></i>
                        </label>
                        <input type="file" class="form-control" name="primary_image" accept="image/jpeg,image/jpg,image/png" {% if not business %}required{% endif %}>
                        <div class="form-text">
                            <strong>Image formats:</strong> JPG, PNG only • <strong>Max size:</strong> 5MB<br>
                            <strong>Recommended:</strong> High-quality, well-lit photo of your business exterior/interior
                        </div>
                        
                        {% if business and business.get_primary_image %}
                            <div class="mt-2">
                                <img src="{{ business.get_primary_image.image.url }}" alt="Primary Image" class="img-thumbnail" style="height: 100px;">
                                <p class="mt-1 mb-0 small text-muted">Current primary image</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Hours Card -->
        {% with subscription=request.user|get_subscription %}
            {% if subscription.plan.price > 0 %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-clock me-2"></i>Business Hours
                        </h5>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Status</th>
                                        <th>Opening Time</th>
                                        <th>Closing Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for day in days_of_week %}
                                        {% with day_hours=business_hours|get_item:day.number %}
                                        <tr>
                                            <td>
                                                <label class="form-label mb-0">{{ day.name }}</label>
                                            </td>
                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input business-day-toggle" type="checkbox" 
                                                           id="closed_{{ day.number }}" name="closed_{{ day.number }}"
                                                           data-target="time-row-{{ day.number }}"
                                                           {% if day_hours.is_closed %}checked{% endif %}>
                                                    <label class="form-check-label" for="closed_{{ day.number }}">
                                                        Closed
                                                    </label>
                                                </div>
                                            </td>
                                            <td>
                                                <div id="time-row-{{ day.number }}" class="{% if day_hours.is_closed %}d-none{% endif %}">
                                                    <input type="time" class="form-control" name="open_time_{{ day.number }}" 
                                                           value="{{ day_hours.open_time|default:'09:00' }}"
                                                           {% if day_hours.is_closed %}disabled{% endif %}>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="{% if day_hours.is_closed %}d-none{% endif %}" id="close-time-{{ day.number }}">
                                                    <input type="time" class="form-control" name="close_time_{{ day.number }}" 
                                                           value="{{ day_hours.close_time|default:'17:00' }}"
                                                           {% if day_hours.is_closed %}disabled{% endif %}>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Services Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-tag me-2"></i>Services Offered
                </h5>
                
                <div id="services-container">
                    {% if services %}
                        {% for service in services %}
                        <div class="row g-3 mb-3 service-row">
                            <div class="col-md-5">
                                <label class="form-label">
                                    Service Name
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Service name: 2-100 characters, letters and numbers allowed (e.g., Web Development, AC Repair)"></i>
                                </label>
                                <input type="text" class="form-control service-name" name="service_name" value="{{ service.name }}" maxlength="100">
                                <div class="form-text">2-100 characters, letters and numbers</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    Short Description (Optional)
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Brief description of the service: up to 200 characters"></i>
                                </label>
                                <input type="text" class="form-control service-description" name="service_description" value="{{ service.description }}" maxlength="200">
                                <div class="form-text">Up to 200 characters</div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger remove-service-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="row g-3 mb-3 service-row">
                            <div class="col-md-5">
                                <label class="form-label">
                                    Service Name
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Service name: 2-100 characters, letters and numbers allowed (e.g., Web Development, AC Repair)"></i>
                                </label>
                                <input type="text" class="form-control service-name" name="service_name" maxlength="100">
                                <div class="form-text">2-100 characters, letters and numbers</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    Short Description (Optional)
                                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Brief description of the service: up to 200 characters"></i>
                                </label>
                                <input type="text" class="form-control service-description" name="service_description" maxlength="200">
                                <div class="form-text">Up to 200 characters</div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger remove-service-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="mt-3">
                    <button type="button" id="add-service-btn" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-1"></i>Add Another Service
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Location Section with Google Maps -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-geo-alt me-2"></i>Business Location
                </h5>
                
                <!-- Location Help -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>How to set your location:</strong>
                    <ol class="mb-0 mt-2">
                        <li>Type your business address in the search box below</li>
                        <li>Select the correct address from suggestions</li>
                        <li>Fine-tune the marker position on the map if needed</li>
                        <li>All location details will be filled automatically</li>
                    </ol>
                </div>
                
                <div class="row g-3">
                    <!-- Location Search Input -->
                    <div class="col-12">
                        <label for="location_search" class="form-label">
                            <i class="bi bi-search me-1"></i>Search Your Business Location <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="location_search" 
                               placeholder="Start typing your business address..."
                               value="{{ business.location_name|default:'' }}">
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            Try: "Shop 123, ABC Market, Sector 15, Gurgaon" or "Near Metro Station, Delhi"
                        </div>
                    </div>
                    
                    <!-- Interactive Map -->
                    <div class="col-12">
                        <label class="form-label">
                            <i class="bi bi-pin-map me-1"></i>Adjust Location on Map
                        </label>
                        <div class="alert alert-secondary small">
                            <i class="bi bi-cursor me-1"></i>
                            Drag the red marker to fine-tune your exact business location
                        </div>
                        <div id="map" style="height: 400px; width: 100%; border-radius: 8px; border: 2px solid #e9ecef;"></div>
                    </div>
                    
                    <!-- Auto-populated Hidden Fields -->
                    <input type="hidden" name="latitude" id="latitude" value="{{ business.latitude|default:'' }}">
                    <input type="hidden" name="longitude" id="longitude" value="{{ business.longitude|default:'' }}">
                    <input type="hidden" name="place_id" id="place_id" value="{{ business.place_id|default:'' }}">
                    <input type="hidden" name="location_name" id="location_name" value="{{ business.location_name|default:'' }}">
                    <input type="hidden" name="formatted_address" id="formatted_address" value="{{ business.formatted_address|default:'' }}">
                    
                    <!-- Auto-populated Display Fields (Readonly) -->
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="bi bi-geo me-1"></i>Full Address
                            <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled from location"></i>
                        </label>
                        <textarea class="form-control bg-light" 
                                  name="address" 
                                  id="address_display" 
                                  rows="3" 
                                  readonly>{{ business.formatted_address|default:'' }}</textarea>
                        <div class="form-text text-muted">
                            <i class="bi bi-info-circle me-1"></i>This will be auto-filled when you select a location
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">
                                    <i class="bi bi-building me-1"></i>City
                                    <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled"></i>
                                </label>
                                <input type="text" 
                                       class="form-control bg-light" 
                                       name="city" 
                                       id="city_display" 
                                       value="{{ business.city|default:'' }}" 
                                       readonly>
                            </div>
                            
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="bi bi-mailbox me-1"></i>Pincode
                                    <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled"></i>
                                </label>
                                <input type="text" 
                                       class="form-control bg-light" 
                                       name="pincode" 
                                       id="pincode_display" 
                                       value="{{ business.pincode|default:'' }}" 
                                       readonly>
                            </div>
                            
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="bi bi-map me-1"></i>State
                                    <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled"></i>
                                </label>
                                <input type="text" 
                                       class="form-control bg-light" 
                                       name="state" 
                                       id="state_display" 
                                       value="{{ business.state|default:'' }}" 
                                       readonly>
                            </div>
                            
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Latitude
                                    <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled"></i>
                                </label>
                                <input type="text" 
                                       class="form-control bg-light" 
                                       id="lat_display" 
                                       value="{{ business.latitude|default:'' }}" 
                                       readonly>
                            </div>
                            
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Longitude
                                    <i class="bi bi-lock-fill text-muted ms-1" title="Auto-filled"></i>
                                </label>
                                <input type="text" 
                                       class="form-control bg-light" 
                                       id="lng_display" 
                                       value="{{ business.longitude|default:'' }}" 
                                       readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DEBUG SECTION - Remove after testing -->
        <div class="card border-warning mb-4" style="background: #fff3cd;">
            <div class="card-body">
                <h6 class="text-warning">DEBUG: Current Business Data</h6>
                <small>
                    <strong>DB Values:</strong><br>
                    Latitude: {{ business.latitude|default:"None" }}<br>
                    Longitude: {{ business.longitude|default:"None" }}<br>
                    City: {{ business.city|default:"None" }}<br>
                    <!-- REMOVED: District: {{ business.district|default:"None" }}<br> -->
                    State: {{ business.state|default:"None" }}<br>
                    Pincode: {{ business.pincode|default:"None" }}<br>
                    Location Name: {{ business.location_name|default:"None" }}<br>
                    Formatted Address: {{ business.formatted_address|default:"None" }}
                </small>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex gap-2 mb-5">
            <button type="submit" name="action" value="draft" class="btn btn-outline-primary">Save as Draft</button>
            <button type="submit" name="action" value="submit" class="btn btn-primary">Submit for Approval</button>
            <a href="{% url 'directory:dashboard_listings' %}" class="btn btn-outline-secondary ms-auto">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// ✅ BETTER FIX: Pass document status from Django template
const businessDocumentStatus = {
    hasRegistrationDoc: {% if business.registration_document %}true{% else %}false{% endif %},
    hasGstDoc: {% if business.gst_document %}true{% else %}false{% endif %},
    registrationNumber: '{{ business.registration_number|default:"" }}',
    gstNumber: '{{ business.gst_number|default:"" }}'
};

console.log('📄 Document status:', businessDocumentStatus);

let map;
let marker;
let autocomplete;
let geocoder;

// Initialize Google Maps
function initMap() {
    console.log('Initializing Google Maps...');
    
    // Check if Google Maps loaded properly
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        console.error('Google Maps API failed to load');
        document.getElementById('map').innerHTML = '<div class="alert alert-danger">Google Maps failed to load. Please check your API configuration.</div>';
        return;
    }
    
    // Get existing coordinates if editing
    const existingLat = document.getElementById('latitude').value;
    const existingLng = document.getElementById('longitude').value;
    const existingLocationName = document.getElementById('location_name').value;
    
    console.log('Existing coordinates:', existingLat, existingLng);
    
    // Default location (India center)
    const defaultLocation = { lat: 20.5937, lng: 78.9629 };
    
    const center = (existingLat && existingLng) ? 
        { lat: parseFloat(existingLat), lng: parseFloat(existingLng) } : 
        defaultLocation;
    
    try {
        // Initialize map
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: existingLat ? 15 : 5,
            center: center,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
        });
        
        // Initialize marker
        marker = new google.maps.Marker({
            position: center,
            map: map,
            draggable: true,
            title: 'Your Business Location',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        // Hide marker if no existing location
        if (!existingLat) {
            marker.setVisible(false);
        }
        
        // Initialize geocoder
        geocoder = new google.maps.Geocoder();
        
        // Initialize autocomplete with error handling
        const input = document.getElementById('location_search');
        
        // Check if Places service is available
        if (typeof google.maps.places === 'undefined') {
            console.error('Google Places API is not available. Please enable Places API in Google Cloud Console.');
            input.placeholder = 'Please enable Google Places API to use search';
            input.disabled = true;
            return;
        }
        
        autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['establishment', 'geocode'],
            componentRestrictions: { country: 'IN' },
            fields: ['formatted_address', 'geometry', 'name', 'place_id', 'address_components']
        });
        
        // Autocomplete place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            console.log('Place selected:', place);
            
            if (!place.geometry) {
                alert('No location details available for this search. Please try a different search term.');
                return;
            }
            
            updateLocationFromPlace(place);
        });
        
        // Map event listeners
        marker.addListener('dragend', function() {
            const position = marker.getPosition();
            reverseGeocode(position.lat(), position.lng());
        });
        
        map.addListener('click', function(event) {
            marker.setPosition(event.latLng);
            marker.setVisible(true);
            reverseGeocode(event.latLng.lat(), event.latLng.lng());
        });
        
        // Pre-populate search field if editing
        if (existingLocationName) {
            input.value = existingLocationName;
            console.log('Pre-populated search field with:', existingLocationName);
        }
        
        console.log('✅ Google Maps initialized successfully');
        
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        document.getElementById('map').innerHTML = '<div class="alert alert-danger">Error loading map: ' + error.message + '</div>';
    }
}

// Update location from place selection
function updateLocationFromPlace(place) {
    const location = place.geometry.location;
    
    // Update map and marker
    map.setCenter(location);
    map.setZoom(15);
    marker.setPosition(location);
    marker.setVisible(true);
    
    // Extract address components
    const addressComponents = extractAddressComponents(place.address_components);
    
    // Enhanced location name handling
    let locationName = place.name || place.formatted_address;
    
    // If place.name exists and is different from formatted_address, use it
    if (place.name && place.name !== place.formatted_address) {
        locationName = place.name;
    } else {
        // Extract a meaningful name from the formatted address
        const addressParts = place.formatted_address.split(',');
        locationName = addressParts[0].trim(); // Use the first part as location name
    }
    
    console.log('Location name extracted:', locationName);
    
    // Update all fields
    updateLocationFields({
        latitude: location.lat(),
        longitude: location.lng(),
        place_id: place.place_id,
        location_name: locationName,
        formatted_address: place.formatted_address,
        ...addressComponents
    });
}

// Reverse geocode coordinates to address
function reverseGeocode(lat, lng) {
    geocoder.geocode({
        location: { lat: lat, lng: lng }
    }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const place = results[0];
            const addressComponents = extractAddressComponents(place.address_components);
            
            updateLocationFields({
                latitude: lat,
                longitude: lng,
                place_id: place.place_id,
                location_name: place.formatted_address,
                formatted_address: place.formatted_address,
                ...addressComponents
            });
            
            // Update search input
            document.getElementById('location_search').value = place.formatted_address;
        }
    });
}

// Extract useful address components - SIMPLIFIED (no district)
function extractAddressComponents(components) {
    const result = {
        city: '',
        state: '',
        pincode: '',
        country: ''
        // REMOVED: district: '',
    };
    
    components.forEach(component => {
        const types = component.types;
        const longName = component.long_name;
        
        // City - multiple fallbacks
        if (types.includes('locality')) {
            result.city = longName;
        } else if (types.includes('sublocality_level_1') && !result.city) {
            result.city = longName;
        } else if (types.includes('administrative_area_level_3') && !result.city) {
            result.city = longName;
        }
        
        // State - reliable
        if (types.includes('administrative_area_level_1')) {
            result.state = longName;
        }
        
        // Pincode - reliable
        if (types.includes('postal_code')) {
            result.pincode = longName;
        }
        
        // Country - reliable
        if (types.includes('country')) {
            result.country = longName;
        }
    });
    
    console.log('🎯 Extracted components:', result);
    return result;
}

// Update all location fields - REMOVED DISTRICT
function updateLocationFields(data) {
    console.log('🔄 Updating location fields with data:', data);
    
    // Hidden fields for form submission
    document.getElementById('latitude').value = data.latitude || '';
    document.getElementById('longitude').value = data.longitude || '';
    document.getElementById('place_id').value = data.place_id || '';
    document.getElementById('location_name').value = data.location_name || '';
    document.getElementById('formatted_address').value = data.formatted_address || '';
    
    // Display fields - REMOVED DISTRICT
    document.getElementById('address_display').value = data.formatted_address || '';
    document.getElementById('city_display').value = data.city || '';
    document.getElementById('state_display').value = data.state || '';
    document.getElementById('pincode_display').value = data.pincode || '';
    // REMOVED: document.getElementById('district_display').value = data.district || '';
    document.getElementById('lat_display').value = data.latitude ? data.latitude.toFixed(6) : '';
    document.getElementById('lng_display').value = data.longitude ? data.longitude.toFixed(6) : '';
    
    console.log('✅ Fields updated:');
    console.log('  City:', data.city);
    console.log('  State:', data.state);
    console.log('  Pincode:', data.pincode);
    // REMOVED: console.log('  District:', data.district);
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('businessForm');
    
    // Conditional upload sections
    const registrationNumberInput = document.querySelector('input[name="registration_number"]');
    const gstNumberInput = document.querySelector('input[name="gst_number"]');
    const registrationUploadSection = document.getElementById('registration-upload-section');
    const gstUploadSection = document.getElementById('gst-upload-section');
    
    // Show/hide registration upload based on registration number
    if (registrationNumberInput) {
        registrationNumberInput.addEventListener('input', function() {
            const value = this.value.trim();
            if (value.length >= 4) {
                registrationUploadSection.style.display = 'block';
                registrationUploadSection.style.animation = 'fadeIn 0.3s ease-in';
                console.log('✅ Registration upload section shown');
            } else {
                registrationUploadSection.style.display = 'none';
                console.log('❌ Registration upload section hidden');
            }
        });
    }
    
    // Show/hide GST upload based on GST number
    if (gstNumberInput) {
        gstNumberInput.addEventListener('input', function() {
            const value = this.value.trim();
            if (value.length >= 10) {
                gstUploadSection.style.display = 'block';
                gstUploadSection.style.animation = 'fadeIn 0.3s ease-in';
                console.log('✅ GST upload section shown');
            } else {
                gstUploadSection.style.display = 'none';
                console.log('❌ GST upload section hidden');
            }
        });
    }
    
    // File validation for both uploads
    const fileInputs = document.querySelectorAll('input[type="file"][name$="_document"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            
            // File size validation (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                this.value = '';
                return;
            }
            
            // File type validation
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload JPG, PNG images or PDF documents only');
                this.value = '';
                return;
            }
            
            // Success feedback
            const fileType = file.type.includes('pdf') ? 'PDF' : 'Image';
            const documentType = this.name.includes('registration') ? 'Registration' : 'GST';
            console.log(`✅ ${documentType} ${fileType} selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            // Add visual feedback
            this.style.borderColor = '#198754';
            this.style.backgroundColor = '#d1e7dd';
        });
    });
    
    // Form submission validation
    if (form) {
        form.addEventListener('submit', function(e) {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            if (!lat || !lng) {
                e.preventDefault();
                alert('Please select a location on the map before submitting.');
                document.getElementById('location_search').focus();
                return false;
            }
            
            // ✅ IMPROVED: Check if registration number is entered but no document uploaded
            const regNumber = registrationNumberInput.value.trim();
            const regDocument = document.querySelector('input[name="registration_document"]').files[0];
            const hasExistingRegDoc = businessDocumentStatus.hasRegistrationDoc;
            
            if (regNumber.length >= 4 && !regDocument && !hasExistingRegDoc) {
                e.preventDefault();
                alert('Please upload your registration certificate document.');
                registrationUploadSection.scrollIntoView({ behavior: 'smooth' });
                return false;
            }
            
            // ✅ IMPROVED: Check if GST number is entered but no document uploaded
            const gstNumber = gstNumberInput.value.trim();
            const gstDocument = document.querySelector('input[name="gst_document"]').files[0];
            const hasExistingGstDoc = businessDocumentStatus.hasGstDoc;
            
            if (gstNumber.length >= 10 && !gstDocument && !hasExistingGstDoc) {
                e.preventDefault();
                alert('Please upload your GST certificate document.');
                gstUploadSection.scrollIntoView({ behavior: 'smooth' });
                return false;
            }
        });
    }
    
    // Real-time field validation
    const phoneInput = document.querySelector('input[name="phone"]');
    const emailInput = document.querySelector('input[name="email"]');
    const gstInput = document.querySelector('input[name="gst_number"]');
    const nameInput = document.querySelector('input[name="name"]');
    
    // Phone validation
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            // Remove non-digits
            this.value = this.value.replace(/\D/g, '');
            
            const phoneRegex = /^[6-9][0-9]{9}$/;
            if (this.value.length === 10 && phoneRegex.test(this.value)) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                this.setCustomValidity('');
            } else if (this.value.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                this.setCustomValidity('Enter a valid 10-digit mobile number starting with 6, 7, 8, or 9');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
                this.setCustomValidity('');
            }
        });
    }
    
    // Email validation
    if (emailInput) {
        emailInput.addEventListener('input', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(this.value)) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                this.setCustomValidity('');
            } else if (this.value.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                this.setCustomValidity('Please enter a valid email address');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
                this.setCustomValidity('');
            }
        });
    }
    
    // GST validation
    if (gstInput) {
        gstInput.addEventListener('input', function() {
            // Convert to uppercase and remove spaces
            this.value = this.value.toUpperCase().replace(/\s/g, '');
            
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            if (this.value.length === 15 && gstRegex.test(this.value)) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                this.setCustomValidity('');
            } else if (this.value.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                this.setCustomValidity('Enter a valid 15-character GST number (e.g., 27AAPFU0939F1ZV)');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
                this.setCustomValidity('');
            }
        });
    }
    
    // Name validation
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            if (this.value.length >= 3 && this.value.length <= 100) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                this.setCustomValidity('');
            } else if (this.value.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                this.setCustomValidity('Business name should be 3-100 characters long');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
                this.setCustomValidity('');
            }
        });
    }
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Load Google Maps API
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
});


// 🚨 EMERGENCY DEBUG CODE - Add this to see what's happening
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('businessForm');
    console.log('🔍 Form element found:', form);
    
    if (form) {
        // Log all form data before submission
        form.addEventListener('submit', function(e) {
            console.log('🚨 FORM SUBMISSION STARTED');
            console.log('📝 Form action:', form.action);
            console.log('📝 Form method:', form.method);
            
            // Log all form data
            const formData = new FormData(form);
            console.log('📄 Form data:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}:`, value);
            }
            
            // Check required fields
            const requiredFields = ['name', 'category', 'description', 'phone', 'email', 'registration_number'];
            let missingFields = [];
            
            requiredFields.forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field && !field.value.trim()) {
                    missingFields.push(fieldName);
                }
            });
            
            if (missingFields.length > 0) {
                console.error('❌ Missing required fields:', missingFields);
                e.preventDefault();
                alert(`Missing required fields: ${missingFields.join(', ')}`);
                return false;
            }
            
            console.log('✅ All required fields filled');
            console.log('🚀 Form submitting...');
        });
        
        // Also check for any validation errors
        const errorElements = form.querySelectorAll('.invalid-feedback');
        if (errorElements.length > 0) {
            console.warn('⚠️ Found validation errors on page load:', errorElements);
        }
    } else {
        console.error('❌ Form element not found!');
    }
});

</script>
{% endblock %}

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-control.valid-file {
    border-color: #198754 !important;
    background-color: #d1e7dd !important;
}

.upload-section-hidden {
    display: none !important;
}

.upload-section-visible {
    display: block !important;
    animation: fadeIn 0.3s ease-in;
}

/* Fix Tooltip Styling */
.tooltip {
    --bs-tooltip-max-width: 300px;
    --bs-tooltip-font-size: 0.875rem;
}

.tooltip-inner {
    max-width: 300px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.4;
    text-align: left;
}

/* Form Validation Styles */
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 0.4 3.5M6 10.4v.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
}

.valid-feedback {
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #198754;
}
</style>

{% with subscription=business.subscription %}
    <!-- Basic business info section (always visible) -->
    <!-- ... -->

    <!-- Premium features - only show if paid plan -->
    {% if business.has_premium_features %}
        <!-- Business Hours Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">Business Hours</h5>
                <!-- Hours content -->
            </div>
        </div>
        
        <!-- Additional images gallery -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="border-bottom pb-2 mb-3">Image Gallery</h5>
                <!-- Gallery content -->
            </div>
        </div>
    {% else %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center">
                <h5 class="border-bottom pb-2 mb-3">Premium Features</h5>
                <p class="text-muted">
                    <i class="bi bi-lock"></i> Unlock advanced features with our Premium plan:
                </p>
                <ul class="list-unstyled mb-4">
                    <li><i class="bi bi-check-circle me-2"></i> Business hours management</li>
                    <li><i class="bi bi-check-circle me-2"></i> Multiple image gallery</li>
                    <li><i class="bi bi-check-circle me-2"></i> Verification badges</li>
                    <li><i class="bi bi-check-circle me-2"></i> Advanced analytics</li>
                </ul>
                <a href="{% url 'directory:subscription_plans' %}?for_business={{ business.id }}" class="btn btn-primary">
                    Upgrade to Premium
                </a>
            </div>
        </div>
    {% endif %}
{% endwith %}