{% extends 'directory/base.html' %}
{% load static %}

{% block title %}Find Local Businesses | BizDirectory{% endblock %}

{% block hero %}
<div class="hero-section">
    <!-- Video Background -->
    <video autoplay muted loop class="hero-video">
        <source src="{% static 'directory/videos/hero-background.mp4' %}" type="video/mp4">
    </video>
    
    <!-- Overlay -->
    <div class="hero-overlay"></div>
    
    <div class="container position-relative">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="search-card">
                    <h1 class="text-center mb-4">Find The Best Local Businesses</h1>
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="searchQuery" class="form-label">What are you looking for?</label>
                            <input type="text" class="form-control" id="searchQuery" name="query" 
                                   placeholder="Search businesses..." value="{{ search_query }}">
                        </div>
                        <div class="col-md-3">
                            <label for="categorySelect" class="form-label">Category</label>
                            <select class="form-select" id="categorySelect" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="pincodeInput" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="pincodeInput" name="pincode" 
                                   placeholder="Enter Pincode" value="{{ selected_pincode }}">
                        </div>
                        <div class="col-md-2 d-flex flex-column justify-content-end position-relative">
                            <button type="submit" class="btn btn-primary w-100">Search</button>
                            {% if search_query or selected_category or selected_pincode %}
                            <div class="position-absolute" style="top: 100%; width: 100%; text-align: center; margin-top: 5px;">
                                <a href="{% url 'directory:home' %}" class="clear-filter small">
                                    <i class="bi bi-x-circle-fill"></i> Clear filters
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Category Showcase Section -->
<div class="category-showcase mb-5 mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Popular Categories</h2>
            <p class="text-muted">Find the services you need by category</p>
        </div>
        <div class="col-auto d-none d-md-block">
            <a href="{% url 'directory:categories' %}" class="btn btn-outline-primary btn-sm">View All Categories</a>
        </div>
    </div>
    
    <!-- Dynamic Category Cards - arranged in 2 rows -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3">
        {% for category in top_categories %}
        <div class="col">
            <a href="/?category={{ category.id }}" class="category-card text-decoration-none">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="category-img-wrapper">
                        <img src="{{ category.get_image_url }}" class="card-img-top" alt="{{ category.name }}">
                        <div class="category-overlay">
                            <span>Explore <i class="bi bi-arrow-right"></i></span>
                        </div>
                    </div>
                    <div class="card-body p-3 text-center">
                        <h5 class="card-title mb-0">{{ category.name }}</h5>
                        <p class="text-muted small mb-0">{{ category.business_count }} business{{ category.business_count|pluralize:"es" }}</p>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Featured Businesses Section (existing code) -->
<div class="row mb-4">
    <div class="col">
        <h2>Featured Businesses</h2>
    </div>
</div>

<!-- Grid View -->
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for business in businesses %}
    <div class="col">
        <div class="card h-100 shadow-sm">
            <img src="{{ business.get_primary_image_url }}" class="card-img-top" alt="{{ business.name }}">
            <div class="card-body">
                <h5 class="card-title">{{ business.name }}</h5>
                
                <!-- Star rating section -->
                <div class="mb-2">
                    <div class="stars me-2">
                        {% for i in "12345" %}
                            {% if forloop.counter <= business.avg_rating|default:0 %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <small class="text-muted">({{ business.reviews.count }} reviews)</small>
                </div>
                
                <p class="card-text">{{ business.description|truncatewords:20 }}</p>
                
                <!-- Category badge -->
                <p class="card-text">
                    <span class="badge bg-secondary">{{ business.category.name }}</span>
                </p>
            </div>

            <!-- Replace the card footer with this improved version -->
            <div class="card-footer bg-light border-top py-2">
                <div class="row g-0">
                    <div class="col-12">
                        <p class="small text-muted mb-1">
                            <i class="bi bi-person-circle me-1"></i> {{ business.owner.get_full_name|default:business.owner.username }}
                        </p>
                    </div>
                    <div class="col-12">
                        <p class="small text-muted mb-0">
                            <i class="bi bi-geo-alt me-1"></i> {{ business.city }} - {{ business.pincode }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="card-footer bg-transparent border-top-0">
                <a href="{% url 'directory:business_detail' business.pk %}" 
                   class="btn btn-outline-primary w-100">View Details</a>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No businesses found matching your criteria.
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search query autocomplete
    $("#searchQuery").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'directory:search_suggestions' %}",
                data: { term: request.term },
                dataType: "json",
                success: function(data) {
                    response(data);
                }
            });
        },
        minLength: 2,
        classes: {
            "ui-autocomplete": "custom-autocomplete shadow-sm"
        }
    });
    
    // Pincode autocomplete
    $("#pincodeInput").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'directory:pincode_suggestions' %}",
                data: { term: request.term },
                dataType: "json",
                success: function(data) {
                    response(data);
                }
            });
        },
        minLength: 1,
        classes: {
            "ui-autocomplete": "custom-autocomplete shadow-sm"
        }
    });
    
    // Add highlighting effect
    $("input, select").on("focus", function() {
        $(this).parent().addClass("shadow-sm");
    }).on("blur", function() {
        $(this).parent().removeClass("shadow-sm");
    });
});
</script>

<style>
.custom-autocomplete {
    z-index: 2000;
    max-height: 300px;
    overflow-y: auto;
    padding: 5px 0;
    border: 1px solid #ddd;
    background-color: white;
    border-radius: 4px;
}

.ui-menu-item {
    padding: 8px 15px !important;
    border: none !important;
    border-radius: 0 !important;
}

.ui-state-active, .ui-menu-item:hover {
    background-color: #f8f9fa !important;
    border: none !important;
    margin: 0 !important;
}
</style>
{% endblock %}