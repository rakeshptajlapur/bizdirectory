{% extends 'directory/base.html' %}
{% load static %}
{% load directory_extras %}

{% block title %}{{ business.name }} | BizDirectory{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Enhanced Special Offer Banner */
    .offer-banner {
        background: linear-gradient(to right, rgba(13, 110, 253, 0.05), rgba(13, 110, 253, 0.1));
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .offer-banner h3 {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.5rem;
    }
    
    .offer-banner p {
        color: #6c757d;
    }
    
    /* Improved form layout */
    .offer-banner .row {
        align-items: center;
    }
    
    .offer-banner form {
        display: flex;
        gap: 0;
    }
    
    .offer-banner .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: none;
    }
    
    .offer-banner .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        background-color: #0d6efd;
        color: white;
        padding-left: 1rem;
        padding-right: 1rem;
        white-space: nowrap;
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .offer-banner {
            padding: 1.5rem;
        }
        
        .offer-banner form {
            margin-top: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Image Gallery Section -->
<div class="gallery-container mb-4 shadow rounded-3">
    <img src="{{ business.get_primary_image_url }}" alt="{{ business.name }}" class="gallery-main" id="mainImage">
    
    <div class="gallery-thumbnails">
        {% for image in business.images.all %}
            <img src="{{ image.image.url }}" 
                 alt="{{ image.caption|default:business.name }}" 
                 class="gallery-thumb {% if image.is_primary %}active{% endif %}"
                 onclick="changeMainImage(this, '{{ image.image.url }}')">
        {% endfor %}
    </div>
</div>

<!-- Business Title, Trust Badges, and Key Info -->
<div class="mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
        <h1 class="mb-0">{{ business.name }}</h1>
        
        <div class="d-flex gap-2 align-items-center">
            <!-- Trust badges -->
            {% if business.gst_verified %}
            <span class="badge bg-success-subtle text-success border border-success-subtle">
                <i class="bi bi-check-circle-fill me-1"></i>GST Verified
            </span>
            {% endif %}
            
            {% if business.kyc_status == 'completed' %}
            <span class="badge bg-success-subtle text-success border border-success-subtle">
                <i class="bi bi-shield-check me-1"></i>KYC Completed
            </span>
            {% elif business.kyc_status == 'pending' %}
            <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                <i class="bi bi-clock-history me-1"></i>KYC Pending
            </span>
            {% endif %}
            
            <!-- Category badge -->
            <a href="{% url 'directory:listings' %}?category={{ business.category.id }}" class="badge bg-primary">
                <i class="bi bi-tag-fill me-1"></i>{{ business.category.name }}
            </a>
        </div>
    </div>
    
    <!-- Rating summary -->
    <div class="d-flex align-items-center mb-3">
        <div class="stars-outer">
            <div class="stars-inner" style="width: {{ business.avg_rating|default:0|floatformat:1|multiply:20 }}%"></div>
        </div>
        <span class="ms-2 text-muted">{{ business.avg_rating|default:0|floatformat:1 }} ({{ business.reviews.count }} reviews)</span>
    </div>
    
    <!-- Quick contact buttons -->
    <div class="d-flex flex-wrap gap-2">
        {% if business.phone %}
        <a href="tel:{{ business.phone }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-telephone-fill me-1"></i>{{ business.phone }}
        </a>
        {% endif %}
        
        {% if business.website %}
        <a href="{{ business.website }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-globe me-1"></i>Visit Website
        </a>
        {% endif %}
        
        <a href="#contact-form" class="btn btn-primary btn-sm">
            <i class="bi bi-envelope-fill me-1"></i>Send Enquiry
        </a>
    </div>
</div>

<!-- Special Offer Banner -->
<div class="offer-banner mb-5">
    <div class="row">
        <div class="col-lg-7 mb-3 mb-lg-0">
            <h3>Special Deal: 20% Off First Service</h3>
            <p class="mb-0">Subscribe to get your exclusive deal code and stay updated with our latest offers.</p>
        </div>
        <div class="col-lg-5">
            <form>
                <input type="email" class="form-control" placeholder="Enter your email" required>
                <button type="submit" class="btn">Get Deal</button>
            </form>
        </div>
    </div>
</div>

<!-- Main Content and Sidebar -->
<div class="row g-4 mb-5">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- About Section -->
        <div class="card info-card mb-4">
            <div class="card-body">
                <h3 class="card-title border-bottom pb-2 mb-3">About</h3>
                <div class="card-text">{{ business.description|linebreaks }}</div>
            </div>
        </div>
        
        <!-- Services Section with Description -->
<div class="card info-card mb-4">
    <div class="card-body">
        <h3 class="card-title border-bottom pb-2 mb-3">Services Offered</h3>
        <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for service in business.services.all %}
                <div class="col">
                    <div class="d-flex align-items-start">
                        <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                            <i class="bi bi-check2-circle text-primary fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">{{ service.name }}</h5>
                            <p class="text-muted small mb-0">{{ service.description }}</p>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="text-muted">No services listed.</p>
            {% endfor %}
        </div>
    </div>
</div>
        
        <!-- Reviews Section -->
        <div class="card info-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-4">
                    <h3 class="card-title mb-0">Customer Reviews</h3>
                    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#addReviewForm">
                        <i class="bi bi-star-fill me-1"></i>Write a Review
                    </button>
                </div>
                
                <!-- Add Review Form (Collapsed by default) -->
                <div class="collapse mb-4" id="addReviewForm">
                    <div class="card card-body border-primary">
                        <form>
                            <h4 class="mb-3">Your Review</h4>
                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <div class="rating-select">
                                    <div class="stars">
                                        {% for i in '12345'|make_list %}
                                            <i class="bi bi-star fs-4 review-star" data-rating="{{ i }}"></i>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="rating" id="ratingInput" value="0">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reviewComment" class="form-label">Your Comment</label>
                                <textarea class="form-control" id="reviewComment" rows="3" placeholder="Share your experience"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                </div>
                
                <!-- Reviews List -->
                {% for review in business.reviews.all %}
                    <div class="review-card p-3 mb-3 bg-light">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="mb-1">{{ review.user.get_full_name|default:review.user.username }}</h5>
                                <div class="d-flex align-items-center">
                                    <div class="stars me-2">
                                        {% for i in "12345"|make_list %}
                                            <i class="bi bi-star{% if forloop.counter <= review.rating %}-fill{% endif %} text-warning"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                        </div>
                        <p class="mt-2 mb-0">{{ review.comment }}</p>
                    </div>
                {% empty %}
                    <div class="text-center py-4">
                        <i class="bi bi-chat-square-text text-muted fs-1"></i>
                        <p class="text-muted mt-2">No reviews yet. Be the first to review!</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Business Hours -->
        <div class="card info-card mb-4">
            <div class="card-body">
                <h4 class="card-title border-bottom pb-2 mb-3">
                    <i class="bi bi-clock me-2"></i>Business Hours
                </h4>
                <ul class="list-group list-group-flush">
                    {% for day_hours in business.hours.all|dictsort:"day" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center 
                                {% if day_hours.day == today_weekday %}bg-light fw-bold{% endif %}">
                            {{ day_hours.get_day_display }}
                            {% if day_hours.is_closed %}
                                <span class="text-danger">Closed</span>
                            {% else %}
                                <span>{{ day_hours.open_time|time:"g:i A" }} - {{ day_hours.close_time|time:"g:i A" }}</span>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li class="list-group-item text-center text-muted">No business hours listed</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Location & Map -->
        <div class="card info-card mb-4">
            <div class="card-body">
                <h4 class="card-title border-bottom pb-2 mb-3">
                    <i class="bi bi-geo-alt me-2"></i>Location
                </h4>
                <address class="mb-3">
                    {{ business.address|linebreaks }}
                    {{ business.city }}, {{ business.pincode }}
                </address>
                
                
                <a href="https://maps.google.com/?q={{ business.address|urlencode }},{{ business.city|urlencode }},{{ business.pincode }}" 
                   class="btn btn-outline-primary w-100" target="_blank">
                    <i class="bi bi-box-arrow-up-right me-1"></i>Open in Google Maps
                </a>
            </div>
        </div>
        
        <!-- Contact Form -->
        <div class="card info-card" id="contact-form">
            <div class="card-body">
                <h4 class="card-title border-bottom pb-2 mb-3">
                    <i class="bi bi-envelope me-2"></i>Send an Enquiry
                </h4>
                <form>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="name" placeholder="Enter your name" required>
                    </div>
                    <div class="mb-3">
                        <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
                    </div>
                    <div class="mb-3">
                        <input type="tel" class="form-control" id="phone" placeholder="Enter your phone">
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" id="message" rows="4" placeholder="What would you like to enquire about?" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-send me-1"></i>Send Message
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Related Businesses -->
<div class="mb-5">
    <h3 class="border-bottom pb-2 mb-4">Similar Businesses</h3>
    
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for related_business in related_businesses %}
            <div class="col">
                <div class="card h-100 shadow-sm business-card">
                    <img src="{{ related_business.get_primary_image_url }}" class="card-img-top" alt="{{ related_business.name }}" style="height: 180px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title">{{ related_business.name }}</h5>
                        <div class="d-flex align-items-center mb-2">
                            <div class="stars me-2">
                                {% for i in "12345"|make_list %}
                                    <i class="bi bi-star{% if forloop.counter <= related_business.avg_rating|default:0 %}-fill{% endif %} text-warning"></i>
                                {% endfor %}
                            </div>
                            <small class="text-muted">({{ related_business.reviews.count }})</small>
                        </div>
                        <p class="card-text small text-muted line-clamp-2">{{ related_business.description }}</p>
                        <a href="{% url 'directory:business_detail' related_business.pk %}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Gallery image switcher
    function changeMainImage(thumb, imgSrc) {
        // Update main image
        document.getElementById('mainImage').src = imgSrc;
        
        // Update active state on thumbnails
        document.querySelectorAll('.gallery-thumb').forEach(item => {
            item.classList.remove('active');
        });
        thumb.classList.add('active');
    }
    
    // Review star selection
    document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelectorAll('.review-star');
        const ratingInput = document.getElementById('ratingInput');
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.getAttribute('data-rating');
                ratingInput.value = rating;
                
                // Update stars display
                stars.forEach(s => {
                    const sRating = s.getAttribute('data-rating');
                    if (sRating <= rating) {
                        s.classList.remove('bi-star');
                        s.classList.add('bi-star-fill');
                        s.classList.add('text-warning');
                    } else {
                        s.classList.add('bi-star');
                        s.classList.remove('bi-star-fill');
                        s.classList.remove('text-warning');
                    }
                });
            });
        });
        
        // Initialize map
        initMap();
    });
    
    // Simple map placeholder
    function initMap() {
        // In a real implementation, you would use Google Maps API
        // This is just a placeholder to show how it would integrate
        const mapDiv = document.getElementById('map');
        mapDiv.innerHTML = `
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                <div class="text-center">
                    <i class="bi bi-map fs-1 text-primary"></i>
                    <p class="mt-2 mb-0">{{ business.address }}, {{ business.city }}</p>
                </div>
            </div>
        `;
    }
</script>
{% endblock %}