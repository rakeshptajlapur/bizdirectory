{% extends 'directory/base.html' %}
{% load static %}

{% block title %}Business Listings | BizDirectory{% endblock %}

{% block hero %}
<!-- =================================================================
     HERO SECTION WITH SEARCH
     ================================================================= -->
<div class="hero-section listings-hero">
    <!-- Video Background -->
    <div class="video-background">
        <video autoplay muted loop class="hero-video">
            <source src="{% static 'directory/videos/hero-background.mp4' %}" type="video/mp4">
        </video>
    </div>
    <div class="hero-overlay"></div>
    
    <!-- Hero Content -->
    <div class="container position-relative">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="search-container">
                    <h1 class="search-title">Find Local Businesses</h1>
                    
                    <!-- Search Form -->
                    <form id="search-form" action="{% url 'directory:listings' %}" method="get" class="search-form">
                        <div class="search-row">
                            <div class="search-input-wrapper">
                                <input type="text" 
                                       id="search-input" 
                                       name="query" 
                                       class="search-input" 
                                       placeholder="Search businesses, services..." 
                                       value="{{ request.GET.query|default:'' }}"
                                       autocomplete="off">
                            </div>
                            <button type="submit" class="search-btn">
                                <i class="bi bi-search me-1"></i>
                                <span class="d-none d-sm-inline">Search</span>
                                <span class="d-sm-none">Go</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- =================================================================
     MOBILE FILTER COMPONENTS
     ================================================================= -->
<!-- Mobile Filter Button -->
<button class="btn btn-primary mobile-filter-btn d-md-none" id="mobileFilterBtn">
    <i class="bi bi-funnel me-2"></i>Filters
    {% if current_filters %}
        <span class="badge bg-light text-primary ms-2">{{ current_filters|length }}</span>
    {% endif %}
</button>

<!-- Mobile Filter Overlay -->
<div class="mobile-filter-overlay" id="mobileFilterOverlay"></div>

<!-- Mobile Filter Container -->
<div class="mobile-filter-container" id="mobileFilterContainer">
    <div class="mobile-filter-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Filters</h5>
            <button class="btn btn-sm btn-outline-secondary" id="closeMobileFilter">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    
    <!-- Mobile Filter Form -->
    <div class="p-3">
        {% include 'directory/partials/mobile_filters.html' %}
    </div>
</div>

<!-- =================================================================
     MAIN CONTENT AREA
     ================================================================= -->
<div class="row">
    <!-- Desktop Filters Sidebar -->
    <div class="col-lg-3 desktop-filters">
        <div class="card mb-4 sticky-top" style="top: 90px; z-index: 1;">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                {% include 'directory/partials/desktop_filters.html' %}
            </div>
        </div>
    </div>

    <!-- Listings Content -->
    <div class="col-12 col-lg-9">
        <!-- Active Filters Display -->
        {% include 'directory/partials/active_filters.html' %}
        
        <!-- Results Count -->
        <p class="text-muted mb-3 mb-md-4 results-header">
            <span id="results-count">Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ paginator.count }} businesses</span>
        </p>
        
        <!-- Business Listings Container -->
        <div id="business-listings-container">
            <!-- Desktop Listings -->
            <div class="d-none d-md-block" id="desktop-listings">
                {% for business in page_obj %}
                    {% include 'directory/partials/desktop_business_card.html' with business=business %}
                {% empty %}
                    {% include 'directory/partials/empty_state.html' %}
                {% endfor %}
            </div>
            
            <!-- Mobile Listings -->
            <div class="d-md-none">
                <div class="row g-3" id="mobile-listings">
                    {% for business in page_obj %}
                        {% include 'directory/partials/mobile_business_card.html' with business=business %}
                    {% empty %}
                        {% include 'directory/partials/empty_state.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Loading & End States -->
        {% include 'directory/partials/loading_states.html' %}
    </div>
</div>

<!-- =================================================================
     STICKY BOTTOM CTA (MOBILE ONLY)
     ================================================================= -->
{% include 'directory/partials/sticky_cta.html' %}
{% endblock %}

{% block extra_css %}
<style>
/* =================================================================
   1. HERO SECTION STYLES - MOBILE OPTIMIZED
   ================================================================= */
.listings-hero {
    min-height: 75px !important;
    padding: 1rem 0 !important;
    position: relative;
    overflow: hidden;
}

/* Mobile hero adjustments */
@media (max-width: 767.98px) {
    .listings-hero {
        min-height: 50px !important; /* Reduced height for mobile */
        padding: 0.75rem 0 !important;
    }
    
    .search-title {
        font-size: 1.4rem !important; /* Smaller heading for mobile */
        margin-bottom: 0.75rem !important;
    }
    
    /* Hide search button on mobile - full width search */
    .search-btn {
        display: none !important;
    }
    
    .search-row {
        flex-direction: column !important;
        gap: 0 !important;
    }
    
    .search-input-wrapper {
        width: 100% !important;
    }
    
    .search-input {
        width: 100% !important;
        border-radius: 12px !important; /* Full rounded corners */
    }
}

.search-container {
    text-align: center;
    padding: 1rem;
}

.search-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
}

/* Search form styling */
.search-form {
    max-width: 600px;
    margin: 0 auto;
}

.search-row {
    display: flex;
    gap: 0.5rem;
    width: 100%;
    align-items: stretch;
}

.search-input-wrapper {
    flex: 1;
    position: relative;
}

.search-input {
    padding: 0.875rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    color: white;
    width: 100%;
    height: 52px;
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

.search-input:focus {
    border-color: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.25);
    outline: none;
}

.search-btn {
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: 12px;
    background: linear-gradient(45deg, #0d6efd, #0dcaf0);
    border: none;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
    transition: all 0.3s ease;
    color: white;
    height: 52px;
    white-space: nowrap;
    min-width: 120px;
}

.search-btn:hover {
    background: linear-gradient(45deg, #0b5ed7, #0aa2c0);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.5);
    color: white;
}

/* Video background styles */
.video-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: -2;
}

.hero-video {
    position: absolute;
    top: 50%;
    left: 50%;
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    transform: translateX(-50%) translateY(-50%);
}

.hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: -1;
}

/* =================================================================
   2. FILTER COMPONENTS - DESKTOP/MOBILE VISIBILITY
   ================================================================= */
/* Hide desktop filters on mobile */
@media (max-width: 767.98px) {
    .desktop-filters {
        display: none !important;
    }
}

/* Hide mobile filter elements on desktop */
@media (min-width: 768px) {
    .mobile-filter-btn,
    .mobile-filter-overlay,
    .mobile-filter-container {
        display: none !important;
    }
}

/* Mobile Filter Components */
.mobile-filter-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
}

.mobile-filter-container {
    position: fixed;
    left: -100%;
    top: 0;
    width: 85%;
    max-width: 350px;
    height: 100%;
    background: white;
    z-index: 1050;
    transition: left 0.3s ease;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.mobile-filter-container.show {
    left: 0;
}

.mobile-filter-header {
    position: sticky;
    top: 0;
    background: white;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    z-index: 10;
}

.mobile-filter-btn {
    position: fixed;
    bottom: 90px; /* Moved up to avoid overlap with sticky CTA */
    left: 20px;
    z-index: 1030;
    border-radius: 50px;
    padding: 12px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 500;
}

/* Mobile only - adjust filter button when sticky CTA is present */
@media (max-width: 767.98px) {
    .mobile-filter-btn {
        bottom: 90px !important; /* Clear space above sticky CTA */
    }
}

/* Desktop Filter Components */
.desktop-filters .card-body {
    padding: 0.75rem;
}

.desktop-filters .card-header {
    padding: 0.5rem 0.75rem;
}

/* Form Controls */
.form-control-sm {
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.form-select-sm {
    padding: 0.4rem 1.75rem 0.4rem 0.6rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.form-label {
    font-size: 0.9rem;
    margin-bottom: 0.4rem;
    font-weight: 600;
}

.mb-3 {
    margin-bottom: 0.75rem !important;
}

/* =================================================================
   3. LAYOUT ADJUSTMENTS FOR MOBILE
   ================================================================= */
@media (max-width: 767.98px) {
    /* Full width listings on mobile */
    .col-12.col-lg-9 {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* Adjust main content layout */
    .row {
        margin-left: 0;
        margin-right: 0;
    }
}

/* =================================================================
   4. STICKY CTA ADJUSTMENTS (OPTIONAL - Remove if you want to hide it)
   ================================================================= */
/* If you want to remove sticky CTA completely on listings page, uncomment this: */
/*
.listings-page .sticky-cta-bottom {
    display: none !important;
}
*/

/* If you want to keep sticky CTA but ensure filter button is visible, use this: */
@media (max-width: 767.98px) {
    .sticky-cta-bottom {
        z-index: 1020; /* Lower than filter button */
    }
    
    .mobile-filter-btn {
        z-index: 1030; /* Higher than sticky CTA */
    }
}

/* =================================================================
   CATEGORY SELECTOR (TAG-BASED) & AUTO-SUGGESTION STYLING
   ================================================================= */
.selected-categories-container {
    min-height: 32px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.4rem;
    background: #f8f9fa;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.selected-categories-container.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-style: italic;
    font-size: 0.8rem;
}

.selected-categories-container.empty::before {
    content: "No categories selected";
}

.category-tag {
    background: linear-gradient(45deg, #0d6efd, #0dcaf0);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
}

.category-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.category-tag .remove-tag {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.65rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.category-tag .remove-tag:hover {
    background: rgba(255, 255, 255, 0.5);
}

.category-search-input {
    font-size: 0.9rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.category-search-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.category-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.category-suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.9rem;
    color: #495057;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
}

.category-suggestion-item:hover {
    background: #f8f9fa;
    color: #0d6efd;
    border-left: 3px solid #0d6efd;
    padding-left: calc(1rem - 3px);
}

.category-suggestion-item:last-child {
    border-bottom: none;
    border-radius: 0 0 8px 8px;
}

.category-suggestion-item.selected {
    background: #e7f1ff;
    color: #0d6efd;
    cursor: default;
}

.category-suggestion-item.selected::after {
    content: "✓";
    color: #0d6efd;
    font-weight: bold;
}

.category-suggestion-item .category-count {
    font-size: 0.8rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
}

/* Category tag animations */
@keyframes tagSlideIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.category-tag.new {
    animation: tagSlideIn 0.3s ease;
}

/* AUTO-SUGGESTION STYLING */
.ui-autocomplete {
    border-radius: 0 0 12px 12px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
    padding: 0 !important;
    background-color: #fff !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-top: none !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    z-index: 9999 !important;
    margin-top: 0 !important;
    font-family: inherit !important;
    width: 450px !important;
    list-style: none !important;
}

.ui-autocomplete {
    overflow-x: hidden !important;
    white-space: nowrap !important;
}

.ui-autocomplete .ui-menu-item {
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    list-style: none !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

.ui-autocomplete .ui-menu-item-wrapper {
    padding: 0.875rem 1.25rem !important;
    cursor: pointer !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    color: #495057 !important;
    font-size: 0.95rem !important;
    border-bottom: 1px solid #f8f9fa !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    background: white !important;
    margin: 0 !important;
    border-left: 3px solid transparent !important;
    font-family: inherit !important;
    text-decoration: none !important;
    min-height: 50px !important;
    box-sizing: border-box !important;
}

.ui-autocomplete .ui-menu-item-wrapper:hover,
.ui-autocomplete .ui-state-active,
.ui-autocomplete .ui-state-focus {
    background-color: #f8f9fa !important;
    color: #0d6efd !important;
    border-left: 3px solid #0d6efd !important;
    padding-left: calc(1.25rem - 3px) !important;
    margin: 0 !important;
    outline: none !important;
}

.ui-autocomplete .ui-menu-item:last-child .ui-menu-item-wrapper {
    border-bottom: none !important;
    border-radius: 0 0 12px 12px !important;
}

.ui-autocomplete::-webkit-scrollbar {
    width: 6px !important;
}

.ui-autocomplete::-webkit-scrollbar-track {
    background: #f8f9fa !important;
    border-radius: 3px !important;
}

.ui-autocomplete::-webkit-scrollbar-thumb {
    background: #dee2e6 !important;
    border-radius: 3px !important;
}

.ui-autocomplete::-webkit-scrollbar-thumb:hover {
    background: #ced4da !important;
}

.ui-autocomplete::-webkit-scrollbar:horizontal {
    display: none !important;
}

.ui-autocomplete {
    scrollbar-width: thin !important;
    scrollbar-color: #dee2e6 #f8f9fa !important;
}

.ui-autocomplete .ui-menu-item-wrapper strong {
    color: #0d6efd !important;
    font-weight: 600 !important;
}

.ui-autocomplete .ui-menu-item-wrapper i {
    color: #6c757d !important;
    margin-right: 0.75rem !important;
    font-size: 0.9rem !important;
    width: 16px !important;
    text-align: center !important;
    flex-shrink: 0 !important;
}

.ui-autocomplete .ui-menu-item-wrapper:hover i,
.ui-autocomplete .ui-state-active i,
.ui-autocomplete .ui-state-focus i {
    color: #0d6efd !important;
}

@media (max-width: 576px) {
    .ui-autocomplete .ui-menu-item-wrapper {
        padding: 0.75rem 1rem !important;
        font-size: 0.9rem !important;
        min-height: 45px !important;
    }
    
    .ui-autocomplete .ui-menu-item-wrapper i {
        margin-right: 0.5rem !important;
    }
    
    .ui-autocomplete .ui-menu-item-wrapper:hover,
    .ui-autocomplete .ui-state-active,
    .ui-autocomplete .ui-state-focus {
        padding-left: calc(1rem - 3px) !important;
    }
}

.search-autocomplete.ui-autocomplete {
    border-radius: 0 0 12px 12px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.search-autocomplete.ui-autocomplete .ui-menu-item-wrapper {
    background: white !important;
    color: #495057 !important;
}

.search-autocomplete.ui-autocomplete .ui-state-active {
    background-color: #f8f9fa !important;
    color: #0d6efd !important;
    border-left: 3px solid #0d6efd !important;
}

/* LOCATION SUGGESTIONS STYLING */
#desktopLocationSuggestions,
#mobileLocationSuggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    z-index: 1050;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    margin-top: 2px;
}

#desktopLocationSuggestions .suggestion-item,
#mobileLocationSuggestions .suggestion-item {
    padding: 0.875rem 1.25rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #495057;
    font-size: 0.95rem;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    background: white;
}

#desktopLocationSuggestions .suggestion-item:hover,
#mobileLocationSuggestions .suggestion-item:hover {
    background-color: #f8f9fa;
    color: #0d6efd;
    border-left: 3px solid #0d6efd;
    padding-left: calc(1.25rem - 3px);
}

#desktopLocationSuggestions .suggestion-item:last-child,
#mobileLocationSuggestions .suggestion-item:last-child {
    border-bottom: none;
    border-radius: 0 0 12px 12px;
}

#desktopLocationSuggestions .suggestion-item i,
#mobileLocationSuggestions .suggestion-item i {
    color: #6c757d;
    margin-right: 0.75rem;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

#desktopLocationSuggestions .suggestion-item:hover i,
#mobileLocationSuggestions .suggestion-item:hover i {
    color: #0d6efd;
}

#desktopLocationSuggestions .suggestion-item strong,
#mobileLocationSuggestions .suggestion-item strong {
    color: #0d6efd;
    font-weight: 600;
}

/* =================================================================
   5. MOBILE BUSINESS CARDS OPTIMIZATION
   ================================================================= */
@media (max-width: 767.98px) {
    /* Mobile business cards - compact design */
    .mobile-business-card {
        border-radius: 8px !important;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        height: auto !important;
        max-height: 280px; /* Limit card height */
    }
    
    .mobile-business-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* Image container - square and compact */
    .mobile-business-card .card-img-top {
        height: 120px !important; /* Reduced from default */
        width: 100% !important;
        object-fit: cover !important;
        object-position: center !important;
    }
    
    /* Category badge on image */
    .mobile-business-card .badge.category-badge {
        font-size: 0.6rem !important;
        padding: 0.2rem 0.4rem !important;
        border-radius: 4px !important;
        font-weight: 500 !important;
        max-width: 80px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }
    
    /* Card body - reduced padding */
    .mobile-business-card .card-body {
        padding: 0.6rem !important; /* Reduced from default 1rem */
        display: flex !important;
        flex-direction: column !important;
        gap: 0.4rem !important;
    }
    
    /* Business title - smaller and compact */
    .mobile-business-card .card-title {
        font-size: 0.9rem !important; /* Much smaller */
        font-weight: 600 !important;
        line-height: 1.2 !important;
        margin-bottom: 0 !important;
        color: #2c3e50 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }
    
    /* Trust badges - smaller and inline */
    .mobile-business-card .d-flex.flex-wrap.gap-1 {
        gap: 0.25rem !important;
        margin-bottom: 0.3rem !important;
    }
    
    .mobile-business-card .badge.bg-success {
        font-size: 0.55rem !important;
        padding: 0.15rem 0.3rem !important;
        border-radius: 3px !important;
        font-weight: 500 !important;
    }
    
    .mobile-business-card .badge.bg-success i {
        font-size: 0.5rem !important;
        margin-right: 0.2rem !important;
    }
    
    /* Rating stars - smaller */
    .mobile-business-card .stars {
        margin-right: 0.4rem !important;
    }
    
    .mobile-business-card .stars i {
        font-size: 0.7rem !important; /* Smaller stars */
        margin-right: 0.1rem !important;
    }
    
    .mobile-business-card .text-muted.small {
        font-size: 0.65rem !important;
        color: #6c757d !important;
    }
    
    /* Hide description on mobile for compactness */
    .mobile-business-card .text-muted.small.mb-2 {
        display: none !important; /* Hide description completely */
    }
    
    /* Card footer - compact */
    .mobile-business-card .card-footer {
        padding: 0.4rem 0.6rem !important; /* Reduced padding */
        background: #f8f9fa !important;
        border-top: 1px solid #e9ecef !important;
        font-size: 0.65rem !important;
    }
    
    .mobile-business-card .card-footer .d-flex {
        align-items: center !important;
        justify-content: space-between !important;
    }
    
    .mobile-business-card .card-footer .text-muted {
        color: #6c757d !important;
        font-size: 0.6rem !important;
        font-weight: 500 !important;
    }
    
    .mobile-business-card .card-footer i {
        font-size: 0.6rem !important;
        margin-right: 0.2rem !important;
    }
    
    /* Mobile grid adjustments */
    .d-md-none .row.g-3 {
        --bs-gutter-x: 0.75rem !important;
        --bs-gutter-y: 0.75rem !important;
        margin: 0 !important;
    }
    
    .d-md-none .col-6 {
        padding-left: 0.375rem !important;
        padding-right: 0.375rem !important;
    }
    
    /* Even more compact for very small screens */
    @media (max-width: 575.98px) {
        .mobile-business-card .card-img-top {
            height: 100px !important; /* Even smaller image */
        }
        
        .mobile-business-card .card-body {
            padding: 0.5rem !important;
            gap: 0.3rem !important;
        }
        
        .mobile-business-card .card-title {
            font-size: 0.8rem !important;
        }
        
        .mobile-business-card .card-footer {
            padding: 0.3rem 0.5rem !important;
        }
        
        .mobile-business-card .stars i {
            font-size: 0.65rem !important;
        }
        
        .mobile-business-card .badge.category-badge {
            font-size: 0.55rem !important;
            padding: 0.15rem 0.3rem !important;
            max-width: 70px !important;
        }
    }
    
    /* Ultra compact for very small screens */
    @media (max-width: 375px) {
        .mobile-business-card .card-img-top {
            height: 90px !important;
        }
        
        .mobile-business-card .card-body {
            padding: 0.4rem !important;
        }
        
        .mobile-business-card .card-title {
            font-size: 0.75rem !important;
        }
        
        .mobile-business-card .card-footer {
            padding: 0.25rem 0.4rem !important;
            font-size: 0.6rem !important;
        }
    }
}

/* =================================================================
   MOBILE BUSINESS CARD SPACING FIXES
   ================================================================= */
@media (max-width: 767.98px) {
    /* Reduce spacing between rating and other elements */
    .mobile-business-card .mb-1 {
        margin-bottom: 0.25rem !important;
    }
    
    /* Tighter card body spacing */
    .mobile-business-card .card-body {
        padding: 0.5rem !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 0.25rem !important; /* Very tight spacing */
    }
    
    /* Compact footer with stacked layout */
    .mobile-business-card .card-footer {
        padding: 0.4rem 0.5rem !important;
        background: #f8f9fa !important;
        border-top: 1px solid #e9ecef !important;
    }
    
    .mobile-business-card .card-footer .d-flex {
        gap: 0.15rem !important; /* Minimal gap between stacked items */
    }
    
    .mobile-business-card .card-footer .text-muted {
        color: #6c757d !important;
        font-size: 0.65rem !important;
        font-weight: 500 !important;
        line-height: 1.2 !important;
    }
    
    .mobile-business-card .card-footer i {
        font-size: 0.6rem !important;
        margin-right: 0.25rem !important;
        width: 10px !important;
        text-align: left !important;
    }
    
    /* Ensure all footer items align properly */
    .mobile-business-card .card-footer small {
        display: flex !important;
        align-items: center !important;
    }
}

/* =================================================================
   6. DESKTOP BUSINESS CARDS - ELEGANT COMPACT SIZE
   ================================================================= */

/* Desktop business card - ELEGANT COMPACT */
.desktop-business-card {
    width: 720px !important; /* Reduced from 800px */
    height: 150px !important; /* Reduced from 200px to 150px */
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    margin: 0 auto 1.2rem auto; /* Slightly reduced margin */
}

.desktop-business-card:hover {
    transform: translateY(-2px); /* Reduced hover effect */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

/* Image area - COMPACT SIZE */
.desktop-business-card .col-3 {
    width: 150px !important; /* Reduced from 200px */
    height: 150px !important; /* Reduced from 200px */
    position: relative;
    overflow: hidden;
    flex: none !important;
}

.desktop-business-card .col-3 img {
    width: 150px !important; /* Reduced from 200px */
    height: 150px !important; /* Reduced from 200px */
    object-fit: cover !important;
    object-position: center !important;
    border-radius: 0 !important;
}

/* Content area - COMPACT SIZE */
.desktop-business-card .col-9 {
    width: 570px !important; /* Reduced from 600px */
    height: 150px !important; /* Reduced from 200px */
    display: flex;
    flex-direction: column;
    flex: none !important;
}

.desktop-business-card .row {
    margin: 0 !important;
    height: 150px !important; /* Reduced from 200px */
    display: flex !important;
    flex-wrap: nowrap !important;
}

/* Category badge positioning */
.desktop-business-card .badge.category-badge {
    position: absolute;
    top: 0.4rem; /* Slightly reduced */
    left: 0.4rem; /* Slightly reduced */
    z-index: 10;
    font-size: 0.65rem; /* Slightly smaller */
    padding: 0.2rem 0.4rem; /* Reduced padding */
    border-radius: 3px;
    background-color: rgba(13, 110, 253, 0.9) !important;
    color: white !important;
    font-weight: 500;
    max-width: 100px; /* Reduced */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
}

/* Card body content - COMPACT LAYOUT */
.desktop-business-card .card-body {
    padding: 0.8rem; /* Reduced from 1rem */
    height: 150px; /* Reduced from 200px */
    width: 570px; /* Reduced from 600px */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* 1. Business Name - COMPACT */
.desktop-business-card .card-title {
    font-size: 1rem; /* Reduced from 1.1rem */
    font-weight: 600;
    line-height: 1.1; /* Tighter line height */
    margin-bottom: 0.3rem; /* Reduced from 0.5rem */
    color: #2c3e50;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 2. Verification Badges - COMPACT */
.desktop-business-card .d-flex.flex-wrap.gap-2 {
    gap: 0.3rem !important; /* Reduced from 0.4rem */
    margin-bottom: 0.3rem; /* Reduced from 0.5rem */
}

.desktop-business-card .badge.bg-success {
    font-size: 0.6rem; /* Reduced from 0.7rem */
    padding: 0.15rem 0.3rem; /* Reduced padding */
    border-radius: 3px;
    font-weight: 500;
}

.desktop-business-card .badge.bg-success i {
    font-size: 0.55rem; /* Reduced from 0.65rem */
    margin-right: 0.15rem; /* Reduced */
}

/* 3. Rating Section - COMPACT */
.desktop-business-card .d-flex.align-items-center.mb-2 {
    margin-bottom: 0.3rem !important; /* Reduced from 0.5rem */
}

.desktop-business-card .stars i {
    font-size: 0.75rem; /* Reduced from 0.85rem */
    margin-right: 0.05rem; /* Reduced */
}

.desktop-business-card .text-muted.small {
    font-size: 0.7rem; /* Reduced from 0.75rem */
}

/* 4. Service Tags - COMPACT */
.desktop-business-card .d-flex.flex-wrap.gap-1 {
    gap: 0.25rem !important; /* Reduced from 0.3rem */
    margin-bottom: 0.3rem !important; /* Reduced from 0.5rem */
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: center !important;
    max-height: 30px; /* Limit height for compactness */
    overflow: hidden;
}

.desktop-business-card .badge.bg-light {
    font-size: 0.6rem; /* Reduced from 0.65rem */
    padding: 0.15rem 0.3rem; /* Reduced padding */
    border-radius: 3px;
    color: #495057 !important;
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef !important;
    line-height: 1.1; /* Tighter line height */
}

.desktop-business-card .badge.bg-secondary {
    font-size: 0.6rem; /* Reduced from 0.65rem */
    padding: 0.15rem 0.3rem; /* Reduced padding */
    border-radius: 3px;
    color: white !important;
    background-color: #6c757d !important;
    line-height: 1.1; /* Tighter line height */
}

/* 5. & 6. Owner and Location Info - COMPACT */
.desktop-business-card .mb-1,
.desktop-business-card .mb-0 {
    display: flex;
    align-items: center;
    margin-bottom: 0.2rem; /* Reduced margin */
}

.desktop-business-card .mb-1 small,
.desktop-business-card .mb-0 small {
    font-size: 0.65rem; /* Reduced from 0.75rem */
    color: #6c757d;
    line-height: 1.1; /* Tighter line height */
    display: flex;
    align-items: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.desktop-business-card .mb-1 i,
.desktop-business-card .mb-0 i {
    font-size: 0.6rem; /* Reduced from 0.7rem */
    margin-right: 0.25rem; /* Reduced from 0.3rem */
    flex-shrink: 0;
    color: #6c757d;
}

/* Large screens - slightly bigger but still COMPACT */
@media (min-width: 1200px) {
    .desktop-business-card {
        width: 800px !important; /* Increased slightly for large screens */
    }
    
    .desktop-business-card .col-3 {
        width: 160px !important;
        height: 160px !important;
    }
    
    .desktop-business-card .col-3 img {
        width: 160px !important;
        height: 160px !important;
    }
    
    .desktop-business-card .col-9 {
        width: 640px !important;
        height: 160px !important;
    }
    
    .desktop-business-card .card-body {
        height: 160px;
        width: 640px;
        padding: 0.9rem; /* Slightly increased for large screens */
    }
    
    .desktop-business-card {
        height: 160px !important;
    }
    
    .desktop-business-card .row {
        height: 160px !important;
    }
    
    .desktop-business-card .card-title {
        font-size: 1.05rem; /* Slightly larger on big screens */
        margin-bottom: 0.4rem;
    }
}

/* Very large screens - elegant but not oversized */
@media (min-width: 1400px) {
    .desktop-business-card {
        width: 850px !important; /* Controlled size even on very large screens */
    }
    
    .desktop-business-card .col-3 {
        width: 170px !important;
        height: 170px !important;
    }
    
    .desktop-business-card .col-3 img {
        width: 170px !important;
        height: 170px !important;
    }
    
    .desktop-business-card .col-9 {
        width: 680px !important;
        height: 170px !important;
    }
    
    .desktop-business-card .card-body {
        height: 170px;
        width: 680px;
        padding: 1rem;
    }
    
    .desktop-business-card {
        height: 170px !important;
    }
    
    .desktop-business-card .row {
        height: 170px !important;
    }
    
    .desktop-business-card .card-title {
        font-size: 1.1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-suggestions for search box
$("#search-input").autocomplete({
    source: function(request, response) {
        $.ajax({
            url: "{% url 'directory:search_suggestions' %}",
            dataType: "json",
            data: {
                term: request.term
            },
            success: function(data) {
                response(data);
            }
        });
    },
    minLength: 2,
    classes: {
        "ui-autocomplete": "search-autocomplete"
    },
    select: function(event, ui) {
        $("#search-input").val(ui.item.value);
        $("#search-form").submit();
        return false;
    }
}).data("ui-autocomplete")._renderItem = function(ul, item) {
    const searchTerm = this.term.trim();
    const regex = new RegExp("(" + searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + ")", "gi");
    const highlightedText = item.label.replace(regex, '<strong class="text-primary">$1</strong>');
    
    return $("<li></li>")
        .data("ui-autocomplete-item", item)
        .append(`<div class='search-suggestion-item'>
            <i class="bi bi-search"></i>
            ${highlightedText}
        </div>`)
        .appendTo(ul);
};

// Mobile filter functionality
document.getElementById('mobileFilterBtn').addEventListener('click', function() {
    document.getElementById('mobileFilterOverlay').style.display = 'block';
    document.getElementById('mobileFilterContainer').classList.add('show');
});

document.getElementById('closeMobileFilter').addEventListener('click', function() {
    document.getElementById('mobileFilterOverlay').style.display = 'none';
    document.getElementById('mobileFilterContainer').classList.remove('show');
});

document.getElementById('mobileFilterOverlay').addEventListener('click', function() {
    this.style.display = 'none';
    document.getElementById('mobileFilterContainer').classList.remove('show');
});

// Initialize Google Places API (same as homepage)
let autocompleteService, placesService;

function initGooglePlaces() {
    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
        autocompleteService = new google.maps.places.AutocompleteService();
        console.log('✅ Google Places API loaded for listings page');
    } else {
        console.log('❌ Google Places API not available');
    }
}

// Location search for both desktop and mobile filters
function initFilterLocationSearch() {
    // Desktop location search
    $('#desktopLocationSearch').on('input', function() {
        handleLocationSearch($(this), '#desktopLocationSuggestions', 'desktop');
    });
    
    // Mobile location search  
    $('#mobileLocationSearch').on('input', function() {
        handleLocationSearch($(this), '#mobileLocationSuggestions', 'mobile');
    });
}

function handleLocationSearch($input, suggestionsId, type) {
    const query = $input.val().trim();
    
    if (query.length < 2) {
        $(suggestionsId).hide();
        return;
    }
    
    if (autocompleteService) {
        const request = {
            input: query,
            componentRestrictions: { country: 'IN' },
            types: ['(cities)']
        };
        
        autocompleteService.getPlacePredictions(request, (predictions, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                const suggestions = predictions.slice(0, 8).map(prediction => ({
                    place_id: prediction.place_id,
                    description: prediction.description
                }));
                showLocationSuggestions(suggestions, query, suggestionsId, type);
            } else {
                fallbackLocationSearch(query, suggestionsId);
            }
        });
    } else {
        fallbackLocationSearch(query, suggestionsId);
    }
}

function showLocationSuggestions(suggestions, query, suggestionsId, type) {
    if (suggestions.length === 0) {
        $(suggestionsId).hide();
        return;
    }
    
    let html = '';
    suggestions.forEach(function(item) {
        const highlighted = highlightMatch(item.description, query);
        html += `<div class="suggestion-item" data-place-id="${item.place_id}" data-description="${item.description}" data-type="${type}">
            <i class="bi bi-geo-alt"></i>
            ${highlighted}
        </div>`;
    });
    
    $(suggestionsId).html(html).show();
}

function fallbackLocationSearch(query, suggestionsId) {
    $.ajax({
        url: "{% url 'directory:location_suggestions' %}",
        data: { term: query },
        success: function(data) {
            const suggestions = data.map(item => ({
                place_id: null,
                description: item
            }));
            showLocationSuggestions(suggestions, query, suggestionsId, 'fallback');
        },
        error: function() {
            $(suggestionsId).hide();
        }
    });
}

function highlightMatch(text, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
}

// Handle location suggestion clicks
$(document).on('click', '.suggestion-item', function(e) {
    e.preventDefault();
    const description = $(this).data('description');
    const placeId = $(this).data('place-id');
    const type = $(this).data('type');
    
    // Update input field
    if (type === 'desktop') {
        $('#desktopLocationSearch').val(description);
        $('#desktopLocationSuggestions').hide();
    } else if (type === 'mobile') {
        $('#mobileLocationSearch').val(description);
        $('#mobileLocationSuggestions').hide();
    }
    
    // Get coordinates if place_id available
    if (placeId && google.maps) {
        const service = new google.maps.places.PlacesService(document.createElement('div'));
        service.getDetails({
            placeId: placeId,
            fields: ['geometry']
        }, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry) {
                if (type === 'desktop') {
                    $('#desktopLat').val(place.geometry.location.lat());
                    $('#desktopLng').val(place.geometry.location.lng());
                    $('#desktopRadius').val(50);
                } else if (type === 'mobile') {
                    $('#mobileLat').val(place.geometry.location.lat());
                    $('#mobileLng').val(place.geometry.location.lng());
                    $('#mobileRadius').val(50);
                }
            }
        });
    }
});

// Hide suggestions on outside click
$(document).on('click', function(e) {
    if (!$(e.target).closest('.position-relative').length) {
        $('.search-suggestions').hide();
    }
});

// Initialize when DOM ready
$(document).ready(function() {
    initFilterLocationSearch();
    
    if (window.google) {
        initGooglePlaces();
    } else {
        window.initGooglePlaces = initGooglePlaces;
    }
});
</script>
<!-- Load Google Maps API using existing env variable -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initGooglePlaces">
</script>
{% endblock %}