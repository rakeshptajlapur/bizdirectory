{% extends 'directory/base.html' %}
{% load static %}

{% block title %}Business Listings | BizDirectory{% endblock %}

{% block hero %}
<!-- =================================================================
     HERO SECTION WITH SEARCH
     ================================================================= -->
<div class="hero-section listings-hero">
    <!-- Video Background -->
    <div class="video-background">
        <video autoplay muted loop class="hero-video">
            <source src="{% static 'directory/videos/hero-background.mp4' %}" type="video/mp4">
        </video>
    </div>
    <div class="hero-overlay"></div>
    
    <!-- Hero Content -->
    <div class="container position-relative">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="search-container">
                    <h1 class="search-title">Find Local Businesses</h1>
                    
                    <!-- Search Form -->
                    <form id="search-form" action="{% url 'directory:listings' %}" method="get" class="search-form">
                        <div class="search-row">
                            <div class="search-input-wrapper">
                                <input type="text" 
                                       id="search-input" 
                                       name="query" 
                                       class="search-input" 
                                       placeholder="Search businesses, services..." 
                                       value="{{ request.GET.query|default:'' }}"
                                       autocomplete="off">
                            </div>
                            <button type="submit" class="search-btn">
                                <i class="bi bi-search me-1"></i>
                                <span class="d-none d-sm-inline">Search</span>
                                <span class="d-sm-none">Go</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- =================================================================
     MOBILE FILTER COMPONENTS
     ================================================================= -->
<!-- Mobile Filter Button -->
<button class="btn btn-primary mobile-filter-btn d-md-none" id="mobileFilterBtn">
    <i class="bi bi-funnel me-2"></i>Filters
    {% if current_filters %}
        <span class="badge bg-light text-primary ms-2">{{ current_filters|length }}</span>
    {% endif %}
</button>

<!-- Mobile Filter Overlay -->
<div class="mobile-filter-overlay" id="mobileFilterOverlay"></div>

<!-- Mobile Filter Container -->
<div class="mobile-filter-container" id="mobileFilterContainer">
    <div class="mobile-filter-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Filters</h5>
            <button class="btn btn-sm btn-outline-secondary" id="closeMobileFilter">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    
    <!-- Mobile Filter Form -->
    <div class="p-3">
        {% include 'directory/partials/mobile_filters.html' %}
    </div>
</div>

<!-- =================================================================
     MAIN CONTENT AREA
     ================================================================= -->
<div class="row">
    <!-- Desktop Filters Sidebar -->
    <div class="col-lg-3 desktop-filters">
        <div class="card mb-4 sticky-top" style="top: 90px; z-index: 1;">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                {% include 'directory/partials/desktop_filters.html' %}
            </div>
        </div>
    </div>

    <!-- Listings Content -->
    <div class="col-12 col-lg-9">
        <!-- Active Filters Display -->
        {% include 'directory/partials/active_filters.html' %}
        
        <!-- Results Count -->
        <p class="text-muted mb-3 mb-md-4 results-header">
            <span id="results-count">Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ paginator.count }} businesses</span>
        </p>
        
        <!-- Business Listings Container -->
        <div id="business-listings-container">
            <!-- Desktop Listings -->
            <div class="d-none d-md-block" id="desktop-listings">
                {% for business in page_obj %}
                    {% include 'directory/partials/desktop_business_card.html' with business=business %}
                {% empty %}
                    {% include 'directory/partials/empty_state.html' %}
                {% endfor %}
            </div>
            
            <!-- Mobile Listings -->
            <div class="d-md-none">
                <div class="row g-3" id="mobile-listings">
                    {% for business in page_obj %}
                        {% include 'directory/partials/mobile_business_card.html' with business=business %}
                    {% empty %}
                        {% include 'directory/partials/empty_state.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Loading & End States -->
        {% include 'directory/partials/loading_states.html' %}
    </div>
</div>

<!-- =================================================================
     STICKY BOTTOM CTA (MOBILE ONLY)
     ================================================================= -->
{% include 'directory/partials/sticky_cta.html' %}
{% endblock %}

{% block extra_css %}
<style>
/* =================================================================
   1. HERO SECTION STYLES
   ================================================================= */
.listings-hero {
    min-height: 75px !important;
    padding: 1rem 0 !important;
    position: relative;
    overflow: hidden;
}

.search-container {
    text-align: center;
    padding: 1rem;
}

.search-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
}

/* Search form styling */
.search-form {
    max-width: 600px;
    margin: 0 auto;
}

.search-row {
    display: flex;
    gap: 0.5rem;
    width: 100%;
    align-items: stretch;
}

.search-input-wrapper {
    flex: 1;
    position: relative;
}

.search-input {
    padding: 0.875rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    color: white;
    width: 100%;
    height: 52px;
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.8);
}

.search-input:focus {
    border-color: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.25);
    outline: none;
}

.search-btn {
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: 12px;
    background: linear-gradient(45deg, #0d6efd, #0dcaf0);
    border: none;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
    transition: all 0.3s ease;
    color: white;
    height: 52px;
    white-space: nowrap;
    min-width: 120px;
}

.search-btn:hover {
    background: linear-gradient(45deg, #0b5ed7, #0aa2c0);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.5);
    color: white;
}

/* Video background styles */
.video-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: -2;
}

.hero-video {
    position: absolute;
    top: 50%;
    left: 50%;
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    transform: translateX(-50%) translateY(-50%);
}

.hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: -1;
}

/* =================================================================
   2. FILTER COMPONENTS
   ================================================================= */
/* Mobile Filter Components */
.mobile-filter-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
}

.mobile-filter-container {
    position: fixed;
    left: -100%;
    top: 0;
    width: 85%;
    max-width: 350px;
    height: 100%;
    background: white;
    z-index: 1050;
    transition: left 0.3s ease;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.mobile-filter-container.show {
    left: 0;
}

.mobile-filter-header {
    position: sticky;
    top: 0;
    background: white;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    z-index: 10;
}

.mobile-filter-btn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1030;
    border-radius: 50px;
    padding: 12px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 500;
}

/* Desktop Filter Components */
.desktop-filters .card-body {
    padding: 0.75rem;
}

.desktop-filters .card-header {
    padding: 0.5rem 0.75rem;
}

/* Form Controls */
.form-control-sm {
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.form-select-sm {
    padding: 0.4rem 1.75rem 0.4rem 0.6rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.form-label {
    font-size: 0.9rem;
    margin-bottom: 0.4rem;
    font-weight: 600;
}

.mb-3 {
    margin-bottom: 0.75rem !important;
}

/* =================================================================
   3. CATEGORY SELECTOR (TAG-BASED)
   ================================================================= */
.selected-categories-container {
    min-height: 32px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.4rem;
    background: #f8f9fa;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.selected-categories-container.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-style: italic;
    font-size: 0.8rem;
}

.selected-categories-container.empty::before {
    content: "No categories selected";
}

.category-tag {
    background: linear-gradient(45deg, #0d6efd, #0dcaf0);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
}

.category-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.category-tag .remove-tag {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.65rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.category-tag .remove-tag:hover {
    background: rgba(255, 255, 255, 0.5);
}

.category-search-input {
    font-size: 0.9rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.category-search-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.category-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.category-suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.9rem;
    color: #495057;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
}

.category-suggestion-item:hover {
    background: #f8f9fa;
    color: #0d6efd;
    border-left: 3px solid #0d6efd;
    padding-left: calc(1rem - 3px);
}

.category-suggestion-item:last-child {
    border-bottom: none;
    border-radius: 0 0 8px 8px;
}

.category-suggestion-item.selected {
    background: #e7f1ff;
    color: #0d6efd;
    cursor: default;
}

.category-suggestion-item.selected::after {
    content: "✓";
    color: #0d6efd;
    font-weight: bold;
}

.category-suggestion-item .category-count {
    font-size: 0.8rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
}

/* Category tag animations */
@keyframes tagSlideIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.category-tag.new {
    animation: tagSlideIn 0.3s ease;
}

/* =================================================================
   4. AUTO-SUGGESTION STYLING - FIXED VERSION
   ================================================================= */

/* Force override jQuery UI autocomplete */
.ui-autocomplete {
    border-radius: 0 0 12px 12px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
    padding: 0 !important;
    background-color: #fff !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-top: none !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    z-index: 9999 !important;
    margin-top: 0 !important;
    font-family: inherit !important;
    width: 450px !important;
    list-style: none !important;
}

/* Hide horizontal scrollbar completely */
.ui-autocomplete {
    overflow-x: hidden !important;
    white-space: nowrap !important;
}

/* Menu items */
.ui-autocomplete .ui-menu-item {
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    list-style: none !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Menu item wrapper - this is the actual clickable area */
.ui-autocomplete .ui-menu-item-wrapper {
    padding: 0.875rem 1.25rem !important;
    cursor: pointer !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    color: #495057 !important;
    font-size: 0.95rem !important;
    border-bottom: 1px solid #f8f9fa !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    background: white !important;
    margin: 0 !important;
    border-left: 3px solid transparent !important;
    font-family: inherit !important;
    text-decoration: none !important;
    min-height: 50px !important;
    box-sizing: border-box !important;
}

/* Hover state */
.ui-autocomplete .ui-menu-item-wrapper:hover,
.ui-autocomplete .ui-state-active,
.ui-autocomplete .ui-state-focus {
    background-color: #f8f9fa !important;
    color: #0d6efd !important;
    border-left: 3px solid #0d6efd !important;
    padding-left: calc(1.25rem - 3px) !important;
    margin: 0 !important;
    outline: none !important;
}

/* Last item */
.ui-autocomplete .ui-menu-item:last-child .ui-menu-item-wrapper {
    border-bottom: none !important;
    border-radius: 0 0 12px 12px !important;
}

/* Custom vertical scrollbar */
.ui-autocomplete::-webkit-scrollbar {
    width: 6px !important;
}

.ui-autocomplete::-webkit-scrollbar-track {
    background: #f8f9fa !important;
    border-radius: 3px !important;
}

.ui-autocomplete::-webkit-scrollbar-thumb {
    background: #dee2e6 !important;
    border-radius: 3px !important;
}

.ui-autocomplete::-webkit-scrollbar-thumb:hover {
    background: #ced4da !important;
}

/* Hide horizontal scrollbar completely */
.ui-autocomplete::-webkit-scrollbar:horizontal {
    display: none !important;
}

/* For Firefox */
.ui-autocomplete {
    scrollbar-width: thin !important;
    scrollbar-color: #dee2e6 #f8f9fa !important;
}

/* Text highlighting in suggestions */
.ui-autocomplete .ui-menu-item-wrapper strong {
    color: #0d6efd !important;
    font-weight: 600 !important;
}

/* Icon styling */
.ui-autocomplete .ui-menu-item-wrapper i {
    color: #6c757d !important;
    margin-right: 0.75rem !important;
    font-size: 0.9rem !important;
    width: 16px !important;
    text-align: center !important;
    flex-shrink: 0 !important;
}

.ui-autocomplete .ui-menu-item-wrapper:hover i,
.ui-autocomplete .ui-state-active i,
.ui-autocomplete .ui-state-focus i {
    color: #0d6efd !important;
}

/* Mobile adjustments */
@media (max-width: 576px) {
    .ui-autocomplete .ui-menu-item-wrapper {
        padding: 0.75rem 1rem !important;
        font-size: 0.9rem !important;
        min-height: 45px !important;
    }
    
    .ui-autocomplete .ui-menu-item-wrapper i {
        margin-right: 0.5rem !important;
    }
    
    .ui-autocomplete .ui-menu-item-wrapper:hover,
    .ui-autocomplete .ui-state-active,
    .ui-autocomplete .ui-state-focus {
        padding-left: calc(1rem - 3px) !important;
    }
}

/* Additional specificity overrides */
.search-autocomplete.ui-autocomplete {
    border-radius: 0 0 12px 12px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.search-autocomplete.ui-autocomplete .ui-menu-item-wrapper {
    background: white !important;
    color: #495057 !important;
}

.search-autocomplete.ui-autocomplete .ui-state-active {
    background-color: #f8f9fa !important;
    color: #0d6efd !important;
    border-left: 3px solid #0d6efd !important;
}

/* =================================================================
   5. LOCATION SUGGESTIONS STYLING - SIMPLIFIED
   ================================================================= */

/* Simple location suggestions without conflicts */
#desktopLocationSuggestions,
#mobileLocationSuggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    z-index: 1050;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    margin-top: 2px;
}

#desktopLocationSuggestions .suggestion-item,
#mobileLocationSuggestions .suggestion-item {
    padding: 0.875rem 1.25rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #495057;
    font-size: 0.95rem;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    background: white;
}

#desktopLocationSuggestions .suggestion-item:hover,
#mobileLocationSuggestions .suggestion-item:hover {
    background-color: #f8f9fa;
    color: #0d6efd;
    border-left: 3px solid #0d6efd;
    padding-left: calc(1.25rem - 3px);
}

#desktopLocationSuggestions .suggestion-item:last-child,
#mobileLocationSuggestions .suggestion-item:last-child {
    border-bottom: none;
    border-radius: 0 0 12px 12px;
}

#desktopLocationSuggestions .suggestion-item i,
#mobileLocationSuggestions .suggestion-item i {
    color: #6c757d;
    margin-right: 0.75rem;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

#desktopLocationSuggestions .suggestion-item:hover i,
#mobileLocationSuggestions .suggestion-item:hover i {
    color: #0d6efd;
}

#desktopLocationSuggestions .suggestion-item strong,
#mobileLocationSuggestions .suggestion-item strong {
    color: #0d6efd;
    font-weight: 600;
}


</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-suggestions for search box
$("#search-input").autocomplete({
    source: function(request, response) {
        $.ajax({
            url: "{% url 'directory:search_suggestions' %}",
            dataType: "json",
            data: {
                term: request.term
            },
            success: function(data) {
                response(data);
            }
        });
    },
    minLength: 2,
    classes: {
        "ui-autocomplete": "search-autocomplete"
    },
    select: function(event, ui) {
        $("#search-input").val(ui.item.value);
        $("#search-form").submit();
        return false;
    }
}).data("ui-autocomplete")._renderItem = function(ul, item) {
    const searchTerm = this.term.trim();
    const regex = new RegExp("(" + searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + ")", "gi");
    const highlightedText = item.label.replace(regex, '<strong class="text-primary">$1</strong>');
    
    return $("<li></li>")
        .data("ui-autocomplete-item", item)
        .append(`<div class='search-suggestion-item'>
            <i class="bi bi-search"></i>
            ${highlightedText}
        </div>`)
        .appendTo(ul);
};

// Mobile filter functionality
document.getElementById('mobileFilterBtn').addEventListener('click', function() {
    document.getElementById('mobileFilterOverlay').style.display = 'block';
    document.getElementById('mobileFilterContainer').classList.add('show');
});

document.getElementById('closeMobileFilter').addEventListener('click', function() {
    document.getElementById('mobileFilterOverlay').style.display = 'none';
    document.getElementById('mobileFilterContainer').classList.remove('show');
});

document.getElementById('mobileFilterOverlay').addEventListener('click', function() {
    this.style.display = 'none';
    document.getElementById('mobileFilterContainer').classList.remove('show');
});

// Initialize Google Places API (same as homepage)
let autocompleteService, placesService;

function initGooglePlaces() {
    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
        autocompleteService = new google.maps.places.AutocompleteService();
        console.log('✅ Google Places API loaded for listings page');
    } else {
        console.log('❌ Google Places API not available');
    }
}

// Location search for both desktop and mobile filters
function initFilterLocationSearch() {
    // Desktop location search
    $('#desktopLocationSearch').on('input', function() {
        handleLocationSearch($(this), '#desktopLocationSuggestions', 'desktop');
    });
    
    // Mobile location search  
    $('#mobileLocationSearch').on('input', function() {
        handleLocationSearch($(this), '#mobileLocationSuggestions', 'mobile');
    });
}

function handleLocationSearch($input, suggestionsId, type) {
    const query = $input.val().trim();
    
    if (query.length < 2) {
        $(suggestionsId).hide();
        return;
    }
    
    if (autocompleteService) {
        const request = {
            input: query,
            componentRestrictions: { country: 'IN' },
            types: ['(cities)']
        };
        
        autocompleteService.getPlacePredictions(request, (predictions, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                const suggestions = predictions.slice(0, 8).map(prediction => ({
                    place_id: prediction.place_id,
                    description: prediction.description
                }));
                showLocationSuggestions(suggestions, query, suggestionsId, type);
            } else {
                fallbackLocationSearch(query, suggestionsId);
            }
        });
    } else {
        fallbackLocationSearch(query, suggestionsId);
    }
}

function showLocationSuggestions(suggestions, query, suggestionsId, type) {
    if (suggestions.length === 0) {
        $(suggestionsId).hide();
        return;
    }
    
    let html = '';
    suggestions.forEach(function(item) {
        const highlighted = highlightMatch(item.description, query);
        html += `<div class="suggestion-item" data-place-id="${item.place_id}" data-description="${item.description}" data-type="${type}">
            <i class="bi bi-geo-alt"></i>
            ${highlighted}
        </div>`;
    });
    
    $(suggestionsId).html(html).show();
}

function fallbackLocationSearch(query, suggestionsId) {
    $.ajax({
        url: "{% url 'directory:location_suggestions' %}",
        data: { term: query },
        success: function(data) {
            const suggestions = data.map(item => ({
                place_id: null,
                description: item
            }));
            showLocationSuggestions(suggestions, query, suggestionsId, 'fallback');
        },
        error: function() {
            $(suggestionsId).hide();
        }
    });
}

function highlightMatch(text, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
}

// Handle location suggestion clicks
$(document).on('click', '.suggestion-item', function(e) {
    e.preventDefault();
    const description = $(this).data('description');
    const placeId = $(this).data('place-id');
    const type = $(this).data('type');
    
    // Update input field
    if (type === 'desktop') {
        $('#desktopLocationSearch').val(description);
        $('#desktopLocationSuggestions').hide();
    } else if (type === 'mobile') {
        $('#mobileLocationSearch').val(description);
        $('#mobileLocationSuggestions').hide();
    }
    
    // Get coordinates if place_id available
    if (placeId && google.maps) {
        const service = new google.maps.places.PlacesService(document.createElement('div'));
        service.getDetails({
            placeId: placeId,
            fields: ['geometry']
        }, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry) {
                if (type === 'desktop') {
                    $('#desktopLat').val(place.geometry.location.lat());
                    $('#desktopLng').val(place.geometry.location.lng());
                    $('#desktopRadius').val(50);
                } else if (type === 'mobile') {
                    $('#mobileLat').val(place.geometry.location.lat());
                    $('#mobileLng').val(place.geometry.location.lng());
                    $('#mobileRadius').val(50);
                }
            }
        });
    }
});

// Hide suggestions on outside click
$(document).on('click', function(e) {
    if (!$(e.target).closest('.position-relative').length) {
        $('.search-suggestions').hide();
    }
});

// Initialize when DOM ready
$(document).ready(function() {
    initFilterLocationSearch();
    
    if (window.google) {
        initGooglePlaces();
    } else {
        window.initGooglePlaces = initGooglePlaces;
    }
});
</script>
<!-- Load Google Maps API using existing env variable -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initGooglePlaces">
</script>
{% endblock %}